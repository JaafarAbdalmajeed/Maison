<?php
/**
 * Product list template - Custom Design
 * @var $block \Magento\Catalog\Block\Product\ListProduct
 * @var \Magento\Framework\Escaper $escaper
 * @var \Magento\Framework\View\Helper\SecureHtmlRenderer $secureRenderer
 */
use Magento\Framework\App\Action\Action;
use Magento\Catalog\Model\Product\Visibility;
use Magento\Catalog\Model\Product\Attribute\Source\Status;

// Try to get loaded product collection - multiple methods
$_productCollection = null;

try {
    // Method 1: Standard way
    $_productCollection = $block->getLoadedProductCollection();
    
    // Method 2: If empty, try getProductCollection
    if ((!$_productCollection || !$_productCollection->count()) && method_exists($block, 'getProductCollection')) {
        $_productCollection = $block->getProductCollection();
    }
    
    // Method 3: If still empty, try from layer
    if ((!$_productCollection || !$_productCollection->count()) && $block->getLayer()) {
        $layer = $block->getLayer();
        if (method_exists($layer, 'getProductCollection')) {
            $_productCollection = $layer->getProductCollection();
        }
    }
    
    // Method 4: If still empty, try to get from current category
    if ((!$_productCollection || !$_productCollection->count())) {
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $registry = $objectManager->get(\Magento\Framework\Registry::class);
        $currentCategory = $registry->registry('current_category');
        
        if ($currentCategory && $currentCategory->getId()) {
            try {
                $productCollectionFactory = $objectManager->get(\Magento\Catalog\Model\ResourceModel\Product\CollectionFactory::class);
                $collection = $productCollectionFactory->create();
                $collection->addAttributeToSelect('*')
                    ->addCategoryFilter($currentCategory)
                    ->addAttributeToFilter('status', \Magento\Catalog\Model\Product\Attribute\Source\Status::STATUS_ENABLED)
                    ->addAttributeToFilter('visibility', [
                        \Magento\Catalog\Model\Product\Visibility::VISIBILITY_BOTH,
                        \Magento\Catalog\Model\Product\Visibility::VISIBILITY_IN_CATALOG
                    ])
                    ->addAttributeToSort('position', 'ASC');
                
                // Get toolbar settings if available
                $toolbarBlock = $block->getToolbarBlock();
                if ($toolbarBlock) {
                    $limit = $toolbarBlock->getLimit();
                    if ($limit) {
                        $collection->setPageSize($limit);
                    }
                    $page = $block->getRequest()->getParam('p', 1);
                    if ($page) {
                        $collection->setCurPage($page);
                    }
                } else {
                    // Default pagination
                    $collection->setPageSize(12)->setCurPage(1);
                }
                
                $_productCollection = $collection;
            } catch (\Exception $e) {
                $logger = $objectManager->get(\Psr\Log\LoggerInterface::class);
                $logger->error('Error creating product collection from category: ' . $e->getMessage());
            }
        }
    }
    
    // Method 5: Last resort - try to get from block's data
    if ((!$_productCollection || !$_productCollection->count()) && $block->getData('product_collection')) {
        $_productCollection = $block->getData('product_collection');
    }
    
} catch (\Exception $e) {
    // Log error for debugging
    $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
    $logger = $objectManager->get(\Psr\Log\LoggerInterface::class);
    $logger->error('Error loading product collection: ' . $e->getMessage());
    $logger->error('Stack trace: ' . $e->getTraceAsString());
} catch (\Throwable $e) {
    // Catch any other errors
    $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
    $logger = $objectManager->get(\Psr\Log\LoggerInterface::class);
    $logger->error('Fatal error loading product collection: ' . $e->getMessage());
}

// Ensure we have a collection object
if (!$_productCollection) {
    $_productCollection = new \Magento\Framework\Data\Collection();
}

/** @var \Magento\Catalog\Helper\Output $_helper */
$_helper = $block->getData('outputHelper');
?>
<?php if (!$_productCollection || !$_productCollection->count()): ?>
    <div class="message info empty">
        <div><?= $escaper->escapeHtml(__('We can\'t find products matching the selection.')) ?></div>
        <?php
        // Debug information (remove in production)
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $registry = $objectManager->get(\Magento\Framework\Registry::class);
        $currentCategory = $registry->registry('current_category');
        
        if ($currentCategory) {
            echo '<div style="margin-top: 10px; font-size: 12px; color: #666;">';
            echo 'Category: ' . $escaper->escapeHtml($currentCategory->getName()) . ' (ID: ' . $currentCategory->getId() . ')';
            echo '<br>Is Active: ' . ($currentCategory->getIsActive() ? 'Yes' : 'No');
            echo '<br>Product Count (from category): ' . $currentCategory->getProductCount();
            echo '</div>';
        } elseif ($block->getLayer() && $block->getLayer()->getCurrentCategory()) {
            $category = $block->getLayer()->getCurrentCategory();
            echo '<div style="margin-top: 10px; font-size: 12px; color: #666;">';
            echo 'Category: ' . $escaper->escapeHtml($category->getName()) . ' (ID: ' . $category->getId() . ')';
            echo '</div>';
        }
        ?>
    </div>
<?php else: ?>
    <?php
    // Force grid view only
    $viewMode = 'grid';
    $imageDisplayArea = 'category_page_grid';
    $showDescription = false;
    $templateType = \Magento\Catalog\Block\Product\ReviewRendererInterface::SHORT_VIEW;
    $pos = $block->getPositioned();
    ?>
    <?= $block->getToolbarHtml() ?>
    <?= $block->getAdditionalHtml() ?>
    <div class="products wrapper grid products-grid">
        <div class="products-grid" id="productsGrid">
            <?php /** @var $_product \Magento\Catalog\Model\Product */ ?>
            <?php foreach ($_productCollection as $_product): ?>
            <div class="product-card product-item grid-item" 
                 data-container="product-grid"
                 id="product-item-info_<?= /* @noEscape */ $_product->getId() ?>">
                <?php
                $productImage = $block->getImage($_product, $imageDisplayArea);
                ?>
                
                <!-- Product Image Wrapper -->
                <div class="product-image-wrapper">
                    <a href="<?= $escaper->escapeUrl($_product->getProductUrl()) ?>" 
                       class="product-image-link"
                       title="<?= $escaper->escapeHtmlAttr($_product->getName()) ?>">
                        <?= $productImage->toHtml() ?>
                    </a>
                    
                    <?php
                    // Product Badge (if bestseller or new)
                    $isBestseller = false;
                    $isNew = false;
                    
                    // Safely check for bestseller attribute
                    try {
                        $bestsellerAttr = $_product->getResource()->getAttribute('bestseller');
                        if ($bestsellerAttr && $bestsellerAttr->getId()) {
                            $bestsellerValue = $_product->getData('bestseller');
                            if ($bestsellerValue) {
                                $source = $bestsellerAttr->getSource();
                                if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                    $isBestseller = $source->getOptionText($bestsellerValue);
                                    // Convert to boolean if needed
                                    $isBestseller = !empty($isBestseller) && ($isBestseller !== false && $isBestseller !== null);
                                }
                            }
                        }
                    } catch (\Exception $e) {
                        // Attribute doesn't exist, ignore
                    } catch (\Throwable $e) {
                        // Catch any other errors
                    }
                    
                    // Safely check for new attribute
                    try {
                        $newAttr = $_product->getResource()->getAttribute('new');
                        if ($newAttr && $newAttr->getId()) {
                            $newValue = $_product->getData('new');
                            if ($newValue) {
                                $source = $newAttr->getSource();
                                if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                    $isNew = $source->getOptionText($newValue);
                                    // Convert to boolean if needed
                                    $isNew = !empty($isNew) && ($isNew !== false && $isNew !== null);
                                }
                            }
                        }
                    } catch (\Exception $e) {
                        // Attribute doesn't exist, ignore
                    } catch (\Throwable $e) {
                        // Catch any other errors
                    }
                    
                    if ($isBestseller): ?>
                        <div class="product-badge"><?= $escaper->escapeHtml(__('BEST SELLER')) ?></div>
                    <?php elseif ($isNew): ?>
                        <div class="product-badge" style="background-color: var(--primary-gold);"><?= $escaper->escapeHtml(__('NEW')) ?></div>
                    <?php endif; ?>
                    
                    <div class="product-quick-view"><?= $escaper->escapeHtml(__('QUICK VIEW')) ?></div>
                    
                    <!-- Wishlist Button -->
                    <?php
                    $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
                    $wishlistHelper = $objectManager->get(\Magento\Wishlist\Helper\Data::class);
                    $customerSession = $objectManager->get(\Magento\Customer\Model\Session::class);
                    $isLoggedIn = $customerSession->isLoggedIn();
                    $isInWishlist = false;
                    if ($isLoggedIn && $wishlistHelper->isAllow()) {
                        $wishlist = $objectManager->get(\Magento\Wishlist\Model\Wishlist::class);
                        $wishlist->loadByCustomerId($customerSession->getCustomerId(), true);
                        $isInWishlist = $wishlist->getItemCollection()->getItemByColumnValue('product_id', $_product->getId()) !== null;
                    }
                    ?>
                    <?php if ($isLoggedIn && $wishlistHelper->isAllow()): ?>
                        <a href="<?= $escaper->escapeUrl($wishlistHelper->getAddParams($_product)) ?>" 
                           class="product-wishlist-btn <?= $isInWishlist ? 'in-wishlist' : '' ?>"
                           data-action="add-to-wishlist"
                           title="<?= $escaper->escapeHtmlAttr($isInWishlist ? __('Remove from Wishlist') : __('Add to Wishlist')) ?>">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="<?= $isInWishlist ? 'currentColor' : 'none' ?>" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                            </svg>
                        </a>
                    <?php endif; ?>
                </div>
                
                <!-- Product Info -->
                <div class="product-info">
                    <?php
                    // Get brand attribute
                    $brand = null;
                    try {
                        $brandAttr = $_product->getResource()->getAttribute('brand');
                        if ($brandAttr && $brandAttr->getId()) {
                            $brandValue = $_product->getData('brand');
                            if ($brandValue) {
                                $source = $brandAttr->getSource();
                                if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                    $brand = $source->getOptionText($brandValue);
                                    // Ensure brand is a valid string
                                    if (empty($brand) || $brand === false || $brand === null) {
                                        $brand = null;
                                    }
                                }
                            }
                        }
                    } catch (\Exception $e) {
                        // Attribute doesn't exist, ignore
                    } catch (\Throwable $e) {
                        // Catch any other errors
                    }
                    if ($brand): ?>
                        <div class="product-brand mb-2"><?= $escaper->escapeHtml($brand) ?></div>
                    <?php endif; ?>
                    
                    <div class="product-details-row">
                        <div class="product-info-text">
                            <h3 class="product-name mb-2">
                                <a href="<?= $escaper->escapeUrl($_product->getProductUrl()) ?>" 
                                   class="product-item-link"
                                   title="<?= $escaper->escapeHtmlAttr($_product->getName()) ?>">
                                    <?=/* @noEscape */ $_helper->productAttribute($_product, $_product->getName(), 'name')?>
                                </a>
                            </h3>
                            <div class="product-price">
                                <?php
                                try {
                                    echo /* @noEscape */ $block->getProductPrice($_product);
                                } catch (\Exception $e) {
                                    // If price rendering fails, show price directly from product
                                    $priceHelper = $block->getLayout()->createBlock(\Magento\Framework\Pricing\Helper\Data::class);
                                    $formattedPrice = $priceHelper->currency($_product->getFinalPrice(), true, false);
                                    echo '<span class="price">' . $escaper->escapeHtml($formattedPrice) . '</span>';
                                } catch (\Throwable $e) {
                                    // Catch any other errors
                                    $priceHelper = $block->getLayout()->createBlock(\Magento\Framework\Pricing\Helper\Data::class);
                                    $formattedPrice = $priceHelper->currency($_product->getFinalPrice(), true, false);
                                    echo '<span class="price">' . $escaper->escapeHtml($formattedPrice) . '</span>';
                                }
                                ?>
                            </div>
                        </div>
                        
                        <?php if ($_product->isSaleable()): ?>
                            <?php $postParams = $block->getAddToCartPostParams($_product); ?>
                            <form data-role="tocart-form"
                                  data-product-sku="<?= $escaper->escapeHtmlAttr($_product->getSku()) ?>"
                                  action="<?= $escaper->escapeUrl($postParams['action']) ?>"
                                  data-mage-init='{"catalogAddToCart": {}}'
                                  method="post">
                                <?php $options = $block->getData('viewModel')->getOptionsData($_product); ?>
                                <?php foreach ($options as $optionItem): ?>
                                    <input type="hidden"
                                           name="<?= $escaper->escapeHtmlAttr($optionItem['name']) ?>"
                                           value="<?= $escaper->escapeHtmlAttr($optionItem['value']) ?>">
                                <?php endforeach; ?>
                                <input type="hidden"
                                       name="product"
                                       value="<?= /* @noEscape */ $postParams['data']['product'] ?>">
                                <input type="hidden"
                                       name="<?= /* @noEscape */ Action::PARAM_NAME_URL_ENCODED ?>"
                                       value="<?= /* @noEscape */ $postParams['data'][Action::PARAM_NAME_URL_ENCODED] ?>">
                                <?= $block->getBlockHtml('formkey') ?>
                                <button type="submit"
                                        title="<?= $escaper->escapeHtmlAttr(__('Add to Cart')) ?>"
                                        class="product-add-to-cart action tocart primary">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                                        <line x1="3" y1="6" x2="21" y2="6"></line>
                                        <path d="M16 10a4 4 0 0 1-8 0"></path>
                                    </svg>
                                    <span><?= $escaper->escapeHtml(__('ADD TO CART')) ?></span>
                                </button>
                            </form>
                        <?php else: ?>
                            <?php if ($_product->isAvailable()): ?>
                                <div class="stock available">
                                    <span><?= $escaper->escapeHtml(__('In stock')) ?></span>
                                </div>
                            <?php else: ?>
                                <div class="stock unavailable">
                                    <span><?= $escaper->escapeHtml(__('Out of stock')) ?></span>
                                </div>
                            <?php endif; ?>
                        <?php endif; ?>
                    </div>
                </div>
            </div>
            <?php endforeach; ?>
        </div>
    </div>
    <?php
    // Get toolbar block - try multiple names
    $toolbarBlock = $block->getChildBlock('toolbar');
    if (!$toolbarBlock) {
        $toolbarBlock = $block->getLayout()->getBlock('product_list_toolbar');
    }
    if (!$toolbarBlock) {
        $toolbarBlock = $block->getLayout()->getBlock('brand_product_list_toolbar');
    }
    if ($toolbarBlock) {
        echo $toolbarBlock->setIsBottom(true)->toHtml();
    }
    ?>
<?php endif; ?>

