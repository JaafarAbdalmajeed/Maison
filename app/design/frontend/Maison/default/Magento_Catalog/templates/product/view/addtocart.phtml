<?php
/**
 * Add to Cart Template - Custom
 * @var \Magento\Catalog\Block\Product\View $block
 */
$_product = $block->getProduct();
if (!$_product || !$_product->isSaleable()) {
    return;
}

// Get post params with fallback
$postParams = null;
$actionUrl = null;
$productId = null;
$urlEncoded = null;

try {
    $postParams = $block->getAddToCartPostParams($_product);
    if ($postParams && isset($postParams['action']) && isset($postParams['data'])) {
        $actionUrl = $postParams['action'];
        $productId = $postParams['data']['product'] ?? $_product->getId();
        $urlEncoded = $postParams['data'][\Magento\Framework\App\ActionInterface::PARAM_NAME_URL_ENCODED] ?? '';
    }
} catch (\Exception $e) {
    // Fallback if method fails
    $postParams = null;
}

// Fallback: create basic params manually if needed
if (!$actionUrl || !$productId) {
    try {
        $actionUrl = $block->getUrl('checkout/cart/add', ['_secure' => $block->getRequest()->isSecure()]);
        $productId = $_product->getId();
        $urlHelper = $this->helper(\Magento\Framework\Url\Helper\Data::class);
        $urlEncoded = $urlHelper->getEncodedUrl($actionUrl);
    } catch (\Exception $e) {
        // Final fallback
        $actionUrl = '/checkout/cart/add/';
        $productId = $_product->getId();
        $urlEncoded = '';
    }
}
?>
<form data-role="tocart-form"
      data-product-sku="<?= $block->escapeHtmlAttr($_product->getSku()) ?>"
      action="<?= $block->escapeUrl($actionUrl) ?>"
      method="post">
    <?= $block->getBlockHtml('formkey') ?>
    <input type="hidden" name="product" value="<?= /* @noEscape */ $productId ?>">
    <input type="hidden" name="<?= /* @noEscape */ \Magento\Framework\App\ActionInterface::PARAM_NAME_URL_ENCODED ?>" value="<?= /* @noEscape */ $urlEncoded ?>">
    
    <!-- Product Options Section -->
    <div class="product-options-section">
        <?php
        // Get configurable product options (color, size, etc.)
        $configurableOptions = [];
        if ($_product->getTypeId() === 'configurable'):
            try {
                $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
                $productTypeInstance = $_product->getTypeInstance();
                $productTypeInstance->setStoreFilter($_product->getStoreId(), $_product);
                $configurableAttributesData = $productTypeInstance->getConfigurableAttributesAsArray($_product);

                foreach ($configurableAttributesData as $attrData):
                    $configurableOptions[$attrData['attribute_code']] = $attrData;
                endforeach;
            } catch (\Exception $e) {
                // Configurable options not available
            }
        endif;

        // Color Selection
        if (isset($configurableOptions['color']) || $_product->getResource()->getAttribute('color')): ?>
            <div class="option-group-detail">
                <label class="option-label-detail"><?= __('Color') ?>: <span class="selected-value" id="selectedColor"><?= __('Select Color') ?></span></label>
                <div class="color-swatches">
                    <?php
                    if (isset($configurableOptions['color'])):
                        $colorOptions = $configurableOptions['color']['values'];
                        $firstColor = true;
                        foreach ($colorOptions as $option):
                            $colorCode = $option['swatch_value'] ?? '#CCCCCC';
                            $colorLabel = $block->escapeHtml($option['label']);
                            $activeClass = $firstColor ? 'active' : '';
                            ?>
                            <button type="button"
                                    class="color-swatch-btn <?= $activeClass ?>"
                                    data-color="<?= $colorLabel ?>"
                                    data-option-id="<?= $option['value_index'] ?>"
                                    style="background-color: <?= $colorCode ?>;"
                                    title="<?= $colorLabel ?>"></button>
                            <?php
                            $firstColor = false;
                        endforeach;
                    else:
                        // Fallback: show example colors if no configurable options
                        ?>
                        <button type="button" class="color-swatch-btn active" data-color="Charcoal" style="background-color: #36454F;"></button>
                        <button type="button" class="color-swatch-btn" data-color="Beige" style="background-color: #F5F5DC;"></button>
                        <button type="button" class="color-swatch-btn" data-color="Navy" style="background-color: #000080;"></button>
                        <button type="button" class="color-swatch-btn" data-color="Emerald" style="background-color: #50C878;"></button>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif;

        // Size Selection
        if (isset($configurableOptions['size']) || $_product->getResource()->getAttribute('size')): ?>
            <div class="option-group-detail">
                <label class="option-label-detail"><?= __('Size') ?>: <span class="selected-value" id="selectedSize"><?= __('Select Size') ?></span></label>
                <div class="size-options">
                    <?php
                    if (isset($configurableOptions['size'])):
                        $sizeOptions = $configurableOptions['size']['values'];
                        $firstSize = true;
                        foreach ($sizeOptions as $option):
                            $sizeLabel = $block->escapeHtml($option['label']);
                            $activeClass = $firstSize ? 'active' : '';
                            ?>
                            <button type="button"
                                    class="size-btn <?= $activeClass ?>"
                                    data-size="<?= $sizeLabel ?>"
                                    data-option-id="<?= $option['value_index'] ?>"><?= $sizeLabel ?></button>
                            <?php
                            $firstSize = false;
                        endforeach;
                    else:
                        // Fallback: show example sizes if no configurable options
                        ?>
                        <button type="button" class="size-btn" data-size="Compact">Compact</button>
                        <button type="button" class="size-btn active" data-size="Standard">Standard</button>
                        <button type="button" class="size-btn" data-size="Oversized">Oversized</button>
                    <?php endif; ?>
                </div>
            </div>
        <?php endif; ?>

        <?php if ($_product->hasOptions()): ?>
            <div class="product-options-wrapper">
                <?= $block->getChildHtml('product.info.options') ?>
            </div>
        <?php endif; ?>

        <!-- Quantity -->
        <div class="option-group-detail">
            <label class="option-label-detail"><?= __('Quantity') ?></label>
            <div class="quantity-selector-detail">
                <button type="button" class="qty-btn-detail qty-minus" id="qtyMinus">-</button>
                <input type="number"
                       name="qty"
                       id="qty"
                       value="1"
                       min="1"
                       max="9999"
                       title="<?= $block->escapeHtmlAttr(__('Qty')) ?>"
                       class="input-text qty qty-input-detail"
                       data-validate="<?= $block->escapeHtml(json_encode(['required-entry' => true, 'validate-greater-than-zero' => true])) ?>">
                <button type="button" class="qty-btn-detail qty-plus" id="qtyPlus">+</button>
            </div>
        </div>
    </div>
    
    <!-- Add to Cart Button -->
    <button type="submit"
            title="<?= $block->escapeHtmlAttr(__('Add to Cart')) ?>"
            id="product-addtocart-button"
            class="btn-add-cart-detail">
        <i data-feather="shopping-bag"></i>
        <span><?= $block->escapeHtml(__('ADD TO CART')) ?></span>
    </button>
</form>

<script>
require(['jquery', 'domReady!', 'mage/url', 'Magento_Ui/js/modal/alert', 'Magento_Ui/js/modal/modal', 'mage/translate', 'mage/loader', 'cartCounter'], function($, domReady, urlBuilder, alert, modal, $t, loader, cartCounter) {
    'use strict';
    
    var productName = '<?= $block->escapeJs($_product->getName()) ?>';
    var productSku = '<?= $block->escapeJs($_product->getSku()) ?>';
    
    // Color swatch selection
    $(document).on('click', '.color-swatch-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var colorName = $(this).data('color');
        $('.color-swatch-btn').removeClass('active');
        $(this).addClass('active');
        $('#selectedColor').text(colorName);
    });

    // Size button selection
    $(document).on('click', '.size-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var sizeName = $(this).data('size');
        $('.size-btn').removeClass('active');
        $(this).addClass('active');
        $('#selectedSize').text(sizeName);
    });

    // Quantity controls
    $(document).on('click', '#qtyPlus', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var qtyInput = $('#qty');
        if (!qtyInput.length) return;
        var currentVal = parseInt(qtyInput.val()) || 1;
        var maxVal = parseInt(qtyInput.attr('max')) || 9999;
        if (currentVal < maxVal) {
            qtyInput.val(currentVal + 1).trigger('change');
        }
    });

    $(document).on('click', '#qtyMinus', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var qtyInput = $('#qty');
        if (!qtyInput.length) return;
        var currentVal = parseInt(qtyInput.val()) || 1;
        var minVal = parseInt(qtyInput.attr('min')) || 1;
        if (currentVal > minVal) {
            qtyInput.val(currentVal - 1).trigger('change');
        }
    });

    // Set initial selected values on page load
    setTimeout(function() {
        var selectedColor = $('.color-swatch-btn.active').data('color');
        if (selectedColor) {
            $('#selectedColor').text(selectedColor);
        }
        var selectedSize = $('.size-btn.active').data('size');
        if (selectedSize) {
            $('#selectedSize').text(selectedSize);
        }
    }, 100);
    
    // Show success message
    function showSuccessMessage(message) {
        var options = {
            type: 'popup',
            responsive: true,
            innerScroll: true,
            title: $t('Success'),
            buttons: [{
                text: $t('Continue Shopping'),
                class: 'action-secondary action-dismiss',
                click: function() {
                    this.closeModal();
                }
            }, {
                text: $t('View Cart'),
                class: 'action-primary',
                click: function() {
                    window.location.href = urlBuilder.build('checkout/cart');
                }
            }]
        };
        var popup = modal(options, $('<div class="add-to-cart-success-modal"><p>' + message + '</p></div>'));
        popup.openModal();
    }
    
    // Show error message
    function showErrorMessage(message) {
        alert({
            title: $t('Error'),
            content: message,
            modalClass: 'alert',
            buttons: [{
                text: $t('OK'),
                class: 'action-primary',
                click: function() {
                    this.closeModal();
                }
            }]
        });
    }
    
    // Add to Cart Form Handler
    $(document).on('submit', 'form[data-role="tocart-form"]', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var $form = $(this);
        var $submitButton = $form.find('#product-addtocart-button');
        var originalButtonHtml = $submitButton.html();
        
        // Disable button and show loading state
        $submitButton.prop('disabled', true);
        $submitButton.find('span').text($t('Adding...'));
        
        // Show loader
        $('body').trigger('processStart');
        
        // Get form data
        var formData = $form.serialize();
        var actionUrl = $form.attr('action');
        
        // Make AJAX request
        $.ajax({
            url: actionUrl,
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                // Hide loader
                $('body').trigger('processStop');
                
                // Re-enable button
                $submitButton.prop('disabled', false);
                $submitButton.html(originalButtonHtml);
                
                // Reinitialize feather icons if needed
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                if (response.backUrl) {
                    // Success - product added to cart
                    var message = response.message || $t('You added %1 to your shopping cart.').replace('%1', productName);
                    showSuccessMessage(message);
                    
                    // Update minicart and cart count using unified cartCounter
                    if (typeof window.customerData !== 'undefined') {
                        var sections = ['cart'];
                        window.customerData.invalidate(sections);
                        window.customerData.reload(sections, true).done(function() {
                            // Update cart count using cartCounter module
                            if (cartCounter && typeof cartCounter.update === 'function') {
                                cartCounter.update(false);
                            }
                            // Update minicart content
                            if (cartCounter && typeof cartCounter.updateMiniCart === 'function') {
                                cartCounter.updateMiniCart();
                            }
                        });
                    }
                    
                    // Trigger events for cart counter and minicart
                    $('body').trigger('updateMiniCart');
                    $(document).trigger('ajax:addToCart');
                    $('[data-block="minicart"]').trigger('contentUpdated');
                    
                    // Force cart count update after a delay
                    setTimeout(function() {
                        if (cartCounter && typeof cartCounter.update === 'function') {
                            cartCounter.update(false);
                        }
                    }, 1000);
                } else if (response.error) {
                    // Error occurred
                    var errorMsg = response.message || $t('Could not add product to cart.');
                    showErrorMessage(errorMsg);
                } else {
                    // Default success
                    showSuccessMessage($t('Product added to cart successfully.'));
                }
            },
            error: function(xhr, status, error) {
                // Hide loader
                $('body').trigger('processStop');
                
                // Re-enable button
                $submitButton.prop('disabled', false);
                $submitButton.html(originalButtonHtml);
                
                // Reinitialize feather icons if needed
                if (typeof feather !== 'undefined') {
                    feather.replace();
                }
                
                var errorMsg = $t('An error occurred while adding the product to cart. Please try again.');
                
                // Try to parse error response
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        var errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.message) {
                            errorMsg = errorResponse.message;
                        }
                    } catch (e) {
                        // If response is HTML, try to extract error message
                        if (xhr.responseText.indexOf('message-error') > -1) {
                            var $temp = $('<div>').html(xhr.responseText);
                            var errorText = $temp.find('.message-error').text();
                            if (errorText) {
                                errorMsg = errorText;
                            }
                        }
                    }
                }
                
                showErrorMessage(errorMsg);
            },
            complete: function() {
                // Ensure loader is hidden
                $('body').trigger('processStop');
                $('.loading-mask').remove();
                $('body').removeClass('_loading');
            }
        });
        
        return false;
    });
});
</script>
