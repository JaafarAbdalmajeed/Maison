<?php
/**
 * Add to Cart Template - Custom
 * @var \Magento\Catalog\Block\Product\View $block
 */
$_product = $block->getProduct();
if (!$_product || !$_product->isSaleable()) {
    return;
}

// Get post params with fallback
$postParams = null;
$actionUrl = null;
$productId = null;
$urlEncoded = null;

try {
    $postParams = $block->getAddToCartPostParams($_product);
    if ($postParams && isset($postParams['action']) && isset($postParams['data'])) {
        $actionUrl = $postParams['action'];
        $productId = $postParams['data']['product'] ?? $_product->getId();
        $urlEncoded = $postParams['data'][\Magento\Framework\App\ActionInterface::PARAM_NAME_URL_ENCODED] ?? '';
    }
} catch (\Exception $e) {
    // Fallback if method fails
    $postParams = null;
}

// Fallback: create basic params manually if needed
if (!$actionUrl || !$productId) {
    try {
        $actionUrl = $block->getUrl('checkout/cart/add', ['_secure' => $block->getRequest()->isSecure()]);
        $productId = $_product->getId();
        $urlHelper = $this->helper(\Magento\Framework\Url\Helper\Data::class);
        $urlEncoded = $urlHelper->getEncodedUrl($actionUrl);
    } catch (\Exception $e) {
        // Final fallback
        $actionUrl = '/checkout/cart/add/';
        $productId = $_product->getId();
        $urlEncoded = '';
    }
}
?>
<form data-role="tocart-form"
      data-product-sku="<?= $block->escapeHtmlAttr($_product->getSku()) ?>"
      action="<?= $block->escapeUrl($actionUrl) ?>"
      data-mage-init='{"catalogAddToCart": {"product_sku": "<?= $block->escapeJs($_product->getSku()) ?>"}}'
      method="post">
    <?= $block->getBlockHtml('formkey') ?>
    <input type="hidden" name="product" value="<?= /* @noEscape */ $productId ?>">
    <input type="hidden" name="<?= /* @noEscape */ \Magento\Framework\App\ActionInterface::PARAM_NAME_URL_ENCODED ?>" value="<?= /* @noEscape */ $urlEncoded ?>">
    
    <!-- Quantity Field -->
    <div class="field qty product-qty-field">
        <label class="label" for="qty">
            <span><?= $block->escapeHtml(__('Quantity')) ?></span>
        </label>
        <div class="control">
            <div class="quantity-selector-detail">
                <button type="button" class="qty-btn-detail qty-minus" id="qtyMinus">-</button>
                <input type="number"
                       name="qty"
                       id="qty"
                       value="1"
                       min="1"
                       max="9999"
                       title="<?= $block->escapeHtmlAttr(__('Qty')) ?>"
                       class="input-text qty"
                       data-validate="<?= $block->escapeHtml(json_encode(['required-entry' => true, 'validate-greater-than-zero' => true])) ?>">
                <button type="button" class="qty-btn-detail qty-plus" id="qtyPlus">+</button>
            </div>
        </div>
    </div>
    
    <?php if ($_product->hasOptions()): ?>
        <?= $block->getChildHtml('product.info.options') ?>
    <?php endif; ?>
    
    <div class="box-tocart product-add-to-cart-container">
        <div class="fieldset">
            <div class="actions">
                <button type="submit"
                        title="<?= $block->escapeHtmlAttr(__('Add to Cart')) ?>"
                        id="product-addtocart-button"
                        class="action primary tocart btn-add-to-cart">
                    <span><?= $block->escapeHtml(__('Add to Cart')) ?></span>
                </button>
            </div>
        </div>
    </div>
</form>

<script type="text/x-magento-init">
{
    "[data-role=tocart-form]": {
        "catalogAddToCart": {
            "product_sku": "<?= $block->escapeJs($_product->getSku()) ?>",
            "bindSubmit": true,
            "redirectToCart": false
        }
    }
}
</script>

<script>
require(['jquery', 'domReady!', 'mage/url', 'Magento_Ui/js/modal/modal', 'mage/translate'], function($, urlBuilder, modal, $t) {
    'use strict';
    
    // Quantity controls
    $(document).on('click', '#qtyPlus', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var qtyInput = $('#qty');
        if (!qtyInput.length) return;
        var currentVal = parseInt(qtyInput.val()) || 1;
        var maxVal = parseInt(qtyInput.attr('max')) || 9999;
        if (currentVal < maxVal) {
            qtyInput.val(currentVal + 1).trigger('change');
        }
    });
    
    $(document).on('click', '#qtyMinus', function(e) {
        e.preventDefault();
        e.stopPropagation();
        var qtyInput = $('#qty');
        if (!qtyInput.length) return;
        var currentVal = parseInt(qtyInput.val()) || 1;
        var minVal = parseInt(qtyInput.attr('min')) || 1;
        if (currentVal > minVal) {
            qtyInput.val(currentVal - 1).trigger('change');
        }
    });
    
    // Show success message
    function showSuccessMessage(message) {
        require(['Magento_Ui/js/modal/alert'], function(alert) {
            alert({
                title: $t('Success'),
                content: message,
                modalClass: 'alert alert-success',
                buttons: [{
                    text: $t('OK'),
                    class: 'action-primary',
                    click: function() {
                        this.closeModal();
                    }
                }]
            });
        });
    }
    
    // Show error message
    function showErrorMessage(message) {
        require(['Magento_Ui/js/modal/alert'], function(alert) {
            alert({
                title: $t('Error'),
                content: message,
                modalClass: 'alert alert-danger',
                buttons: [{
                    text: $t('OK'),
                    class: 'action-primary',
                    click: function() {
                        this.closeModal();
                    }
                }]
            });
        });
    }
    
    // Add to Cart via AJAX
    function addToCartAjax(form) {
        var $form = $(form);
        var formData = $form.serialize();
        var submitButton = $form.find('#product-addtocart-button');
        
        // Disable button during request
        submitButton.prop('disabled', true).text($t('Adding...'));
        
        $.ajax({
            url: $form.attr('action'),
            type: 'POST',
            data: formData,
            showLoader: true,
            success: function(response) {
                submitButton.prop('disabled', false);
                var originalText = submitButton.data('original-text') || $t('Add to Cart');
                submitButton.text(originalText);
                
                // Check if response is HTML or JSON
                var responseData = response;
                if (typeof response === 'string') {
                    try {
                        responseData = JSON.parse(response);
                    } catch (e) {
                        // If it's HTML, check for success indicators
                        if (response.indexOf('message-success') > -1 || response.indexOf('success') > -1) {
                            responseData = { success: true, message: $t('Product added to cart successfully.') };
                        } else {
                            responseData = { error: true, message: $t('Could not add product to cart.') };
                        }
                    }
                }
                
                if (responseData.backUrl || responseData.success) {
                    // Product added successfully
                    var productName = '<?= $block->escapeJs($_product->getName()) ?>';
                    var message = responseData.message || $t('You added %1 to your shopping cart.').replace('%1', productName);
                    
                    // Show success message
                    showSuccessMessage(message);
                    
                    // Update minicart if exists
                    if (typeof window.customerData !== 'undefined') {
                        var sections = ['cart'];
                        customerData.invalidate(sections);
                        customerData.reload(sections, true);
                    }
                    
                    // Trigger minicart update event
                    $('body').trigger('updateMiniCart');
                    $(document).trigger('ajax:addToCart');
                    
                    // Update cart count in header if exists
                    $('[data-block="minicart"]').trigger('contentUpdated');
                } else if (responseData.error || responseData.message) {
                    // Show error message
                    var errorMsg = responseData.message || $t('Could not add product to cart.');
                    showErrorMessage(errorMsg);
                } else {
                    // Default success if no clear response
                    showSuccessMessage($t('Product added to cart successfully.'));
                }
            },
            error: function(xhr, status, error) {
                submitButton.prop('disabled', false);
                var originalText = submitButton.data('original-text') || $t('Add to Cart');
                submitButton.text(originalText);
                
                var errorMsg = $t('An error occurred while adding the product to cart. Please try again.');
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMsg = xhr.responseJSON.message;
                } else if (xhr.responseText) {
                    try {
                        var errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse.message) {
                            errorMsg = errorResponse.message;
                        }
                    } catch (e) {
                        // Use default error message
                    }
                }
                
                showErrorMessage(errorMsg);
            }
        });
        
        return false;
    }
    
    // Enable Add to Cart button
    function enableAddToCartButton() {
        var addToCartButton = $('#product-addtocart-button');
        if (addToCartButton.length) {
            // Force remove disabled
            addToCartButton.prop('disabled', false);
            addToCartButton.removeAttr('disabled');
            addToCartButton.removeClass('disabled');
            
            // Force styling
            addToCartButton.css({
                'pointer-events': 'auto',
                'opacity': '1',
                'cursor': 'pointer',
                'background-color': '',
                'color': ''
            });
            
            // Store original button text
            if (!addToCartButton.data('original-text')) {
                addToCartButton.data('original-text', addToCartButton.text());
            }
            
            // Custom submit handler to prevent redirect
            var $form = addToCartButton.closest('form[data-role="tocart-form"]');
            $form.off('submit.addToCart').on('submit.addToCart', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Validate form
                if (this.checkValidity && !this.checkValidity()) {
                    this.reportValidity();
                    return false;
                }
                
                // Ensure quantity is valid
                var qty = parseInt($('#qty').val()) || 1;
                if (qty < 1) {
                    $('#qty').val(1);
                }
                
                // Add to cart via AJAX
                addToCartAjax(this);
                
                return false;
            });
        }
    }
    
    // Initialize immediately and on ready
    enableAddToCartButton();
    
    $(document).ready(function() {
        enableAddToCartButton();
        
        // Monitor for button disable attempts
        var addToCartButton = $('#product-addtocart-button');
        if (addToCartButton.length) {
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes') {
                        var target = $(mutation.target);
                        if (target.is('#product-addtocart-button')) {
                            if (mutation.attributeName === 'disabled' && target.prop('disabled')) {
                                setTimeout(enableAddToCartButton, 10);
                            } else if (mutation.attributeName === 'class' && target.hasClass('disabled')) {
                                setTimeout(enableAddToCartButton, 10);
                            }
                        }
                    }
                });
            });
            
            observer.observe(addToCartButton[0], {
                attributes: true,
                attributeFilter: ['disabled', 'class', 'style']
            });
        }
        
        // Also check periodically (fallback)
        setInterval(function() {
            var btn = $('#product-addtocart-button');
            if (btn.length && btn.prop('disabled')) {
                enableAddToCartButton();
            }
        }, 500);
    });
    
    // Also enable on full page load
    $(window).on('load', function() {
        setTimeout(enableAddToCartButton, 100);
    });
    
    // Initialize on document ready
    $(document).ready(function() {
        enableAddToCartButton();
    });
});
</script>

