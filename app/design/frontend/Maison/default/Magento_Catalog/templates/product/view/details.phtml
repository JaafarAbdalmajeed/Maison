<?php
/**
 * Product Details Tabs Template - Custom Design
 * @var \Magento\Catalog\Block\Product\View\Description $block
 */
$_product = $block->getProduct();
if (!$_product || !$_product->getId()) {
    return; // Exit if no product
}

$_helper = $this->helper('Magento\Catalog\Helper\Output');

// Safely get review count and average rating
$reviewCount = 0;
$averageRating = 0;
$ratingSummary = null;
try {
    if ($_product && $_product->getId()) {
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $reviewFactory = $objectManager->get(\Magento\Review\Model\ReviewFactory::class);
        $review = $reviewFactory->create();
        $review->getEntitySummary($_product);
        $ratingSummary = $_product->getRatingSummary();
        if ($ratingSummary) {
            $reviewCount = $ratingSummary->getReviewsCount() ?: 0;
            $ratingPercent = $ratingSummary->getRatingSummary() ?: 0;
            $averageRating = round(($ratingPercent / 20), 1); // Convert to 5-star scale with 1 decimal
        }
    }
} catch (\Exception $e) {
    // Reviews not available, use 0
    $reviewCount = 0;
    $averageRating = 0;
} catch (\Throwable $e) {
    // Reviews not available, use 0
    $reviewCount = 0;
    $averageRating = 0;
}

// Get review list
$reviewCollection = null;
try {
    if ($_product && $_product->getId()) {
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $reviewCollectionFactory = $objectManager->get(\Magento\Review\Model\ResourceModel\Review\CollectionFactory::class);
        $reviewCollection = $reviewCollectionFactory->create()
            ->addStatusFilter(\Magento\Review\Model\Review::STATUS_APPROVED)
            ->addEntityFilter('product', $_product->getId())
            ->addStoreFilter($objectManager->get(\Magento\Store\Model\StoreManagerInterface::class)->getStore()->getId())
            ->setDateOrder()
            ->setPageSize(5) // Show 5 reviews initially
            ->setCurPage(1);
    }
} catch (\Exception $e) {
    $reviewCollection = null;
} catch (\Throwable $e) {
    $reviewCollection = null;
}
?>

<section class="product-tabs-section">
    <div class="container-fluid px-4 px-lg-5">
        <div class="row g-4">
            <!-- Left: Vertical Tabs + Content -->
            <div class="col-lg-8">
                <div class="product-tabs-vertical">
                    <div class="tabs-nav-vertical">
                        <button class="tab-btn-vertical active" data-tab="description"><?= __('DESCRIPTION') ?></button>
                        <button class="tab-btn-vertical" data-tab="specifications"><?= __('SPECIFICATIONS') ?></button>
                        <button class="tab-btn-vertical" data-tab="reviews"><?= __('REVIEWS') ?> <?= $reviewCount > 0 ? '(' . $reviewCount . ')' : '' ?></button>
                    </div>
                    
                    <div class="tabs-content-vertical">
                        <!-- Description Tab -->
                        <div class="tab-pane active" id="description">
                            <div class="row g-5">
                                <div class="col-lg-8">
                                    <h3 class="tab-heading"><?= __('Product Description') ?></h3>
                                    <?php if ($_product && $_product->getDescription()): ?>
                                        <?= $_helper->productAttribute($_product, $_product->getDescription(), 'description') ?>
                                    <?php else: ?>
                                        <p><?= __('No description available.') ?></p>
                                    <?php endif; ?>
                                    
                                    <?php 
                                    // Get additional attributes for features
                                    $features = [];
                                    if ($_product && $_product->getId()) {
                                        $attributes = ['features', 'key_features', 'highlights'];
                                        foreach ($attributes as $attrCode) {
                                            try {
                                                $attr = $_product->getResource()->getAttribute($attrCode);
                                                if ($attr && $attr->getId() && $_product->getData($attrCode)) {
                                                    // Safely get attribute text
                                                    $source = $attr->getSource();
                                                    if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                                        $attrValue = $_product->getData($attrCode);
                                                        if ($attrValue) {
                                                            $featureText = $source->getOptionText($attrValue);
                                                            if ($featureText) {
                                                                $features[] = $featureText;
                                                            }
                                                        }
                                                    } else {
                                                        // Fallback to raw value
                                                        $features[] = $_product->getData($attrCode);
                                                    }
                                                }
                                            } catch (\Exception $e) {
                                                // Skip this attribute if error
                                                continue;
                                            } catch (\Throwable $e) {
                                                // Skip this attribute if any error
                                                continue;
                                            }
                                        }
                                    }
                                    if (!empty($features)): ?>
                                        <h4 class="sub-heading"><?= __('Key Features') ?>:</h4>
                                        <ul class="features-list">
                                            <?php foreach ($features as $feature): ?>
                                                <li><?= $block->escapeHtml($feature) ?></li>
                                            <?php endforeach; ?>
                                        </ul>
                                    <?php endif; ?>
                                </div>
                                <div class="col-lg-4">
                                    <div class="info-box">
                                        <h4 class="info-box-title"><?= __('Care Instructions') ?></h4>
                                        <ul class="info-list">
                                            <?php 
                                            $careInstructions = null;
                                            if ($_product && $_product->getId()) {
                                                try {
                                                    $careAttr = $_product->getResource()->getAttribute('care_instructions');
                                                    if ($careAttr && $careAttr->getId()) {
                                                        $careValue = $_product->getData('care_instructions');
                                                        if ($careValue) {
                                                            $source = $careAttr->getSource();
                                                            if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                                                $careInstructions = $source->getOptionText($careValue);
                                                            } else {
                                                                $careInstructions = $careValue;
                                                            }
                                                        }
                                                    }
                                                } catch (\Exception $e) {
                                                    // Attribute doesn't exist, use defaults
                                                } catch (\Throwable $e) {
                                                    // Attribute doesn't exist, use defaults
                                                }
                                            }
                                            
                                            if ($careInstructions):
                                                if (is_array($careInstructions)):
                                                    foreach ($careInstructions as $instruction): ?>
                                                        <li><?= $block->escapeHtml($instruction) ?></li>
                                                    <?php endforeach;
                                                else: ?>
                                                    <li><?= $block->escapeHtml($careInstructions) ?></li>
                                                <?php endif;
                                            else: ?>
                                                <li><?= __('Vacuum regularly with soft brush') ?></li>
                                                <li><?= __('Professional cleaning recommended') ?></li>
                                                <li><?= __('Avoid direct sunlight') ?></li>
                                                <li><?= __('Rotate cushions periodically') ?></li>
                                            <?php endif; ?>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Specifications Tab -->
                        <div class="tab-pane" id="specifications">
                            <div class="specifications-grid">
                                <?php 
                                // Get product attributes for specifications
                                $specAttributes = [
                                    'dimensions' => __('Dimensions (W x D x H)'),
                                    'weight' => __('Weight'),
                                    'material' => __('Material'),
                                    'color' => __('Color'),
                                    'warranty' => __('Warranty'),
                                    'country_of_manufacture' => __('Made In'),
                                    'assembly_required' => __('Assembly Required'),
                                ];
                                
                                foreach ($specAttributes as $attrCode => $label):
                                    try {
                                        $attr = $_product->getResource()->getAttribute($attrCode);
                                        if ($attr && $attr->getId() && $_product->getData($attrCode)):
                                            // Safely get attribute text
                                            $value = null;
                                            try {
                                                // Check if attribute has source model
                                                $source = $attr->getSource();
                                                if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                                    $attrValue = $_product->getData($attrCode);
                                                    if ($attrValue) {
                                                        $value = $source->getOptionText($attrValue);
                                                    }
                                                }
                                            } catch (\Exception $e) {
                                                // If getSource fails, use raw value
                                                $value = $_product->getData($attrCode);
                                            }
                                            
                                            // Fallback to raw value if getOptionText failed
                                            if (!$value) {
                                                $value = $_product->getData($attrCode);
                                            }
                                            
                                            if ($value): ?>
                                                <div class="spec-row">
                                                    <div class="spec-label"><?= $block->escapeHtml($label) ?></div>
                                                    <div class="spec-value"><?= $block->escapeHtml($value) ?></div>
                                                </div>
                                            <?php endif;
                                        endif;
                                    } catch (\Exception $e) {
                                        // Skip this attribute if error
                                        continue;
                                    } catch (\Throwable $e) {
                                        // Skip this attribute if any error
                                        continue;
                                    }
                                endforeach;
                                
                                // Additional attributes
                                try {
                                    $additionalAttrs = $_product->getAttributes();
                                    foreach ($additionalAttrs as $attr):
                                        try {
                                            if ($attr && $attr->getIsVisibleOnFront() && 
                                                $attr->getIsUserDefined() && 
                                                !in_array($attr->getAttributeCode(), array_keys($specAttributes)) &&
                                                $_product->getData($attr->getAttributeCode())):
                                                
                                                // Safely get attribute text
                                                $value = null;
                                                try {
                                                    $source = $attr->getSource();
                                                    if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                                                        $attrValue = $_product->getData($attr->getAttributeCode());
                                                        if ($attrValue) {
                                                            $value = $source->getOptionText($attrValue);
                                                        }
                                                    }
                                                } catch (\Exception $e) {
                                                    // If getSource fails, use raw value
                                                    $value = $_product->getData($attr->getAttributeCode());
                                                }
                                                
                                                // Fallback to raw value if getOptionText failed
                                                if (!$value) {
                                                    $value = $_product->getData($attr->getAttributeCode());
                                                }
                                                
                                                if ($value && $value != 'No' && $value != '0'): ?>
                                                    <div class="spec-row">
                                                        <div class="spec-label"><?= $block->escapeHtml($attr->getFrontendLabel()) ?></div>
                                                        <div class="spec-value"><?= $block->escapeHtml($value) ?></div>
                                                    </div>
                                                <?php endif;
                                            endif;
                                        } catch (\Exception $e) {
                                            // Skip this attribute if error
                                            continue;
                                        } catch (\Throwable $e) {
                                            // Skip this attribute if any error
                                            continue;
                                        }
                                    endforeach;
                                } catch (\Exception $e) {
                                    // Error getting attributes, ignore
                                } catch (\Throwable $e) {
                                    // Error getting attributes, ignore
                                }
                                ?>
                            </div>
                        </div>
                        
                        <!-- Reviews Tab -->
                        <div class="tab-pane" id="reviews">
                            <?php if ($reviewCount > 0): ?>
                                <!-- Reviews Summary -->
                                <div class="reviews-summary">
                                    <div class="rating-overview">
                                        <div class="average-rating"><?= $block->escapeHtml($averageRating) ?></div>
                                        <div class="rating-details">
                                            <div class="stars-large">
                                                <?php 
                                                $fullStars = floor($averageRating);
                                                $hasHalfStar = ($averageRating - $fullStars) >= 0.5;
                                                for ($i = 1; $i <= 5; $i++): 
                                                    if ($i <= $fullStars): ?>
                                                        <i data-feather="star" class="star-filled"></i>
                                                    <?php elseif ($i == $fullStars + 1 && $hasHalfStar): ?>
                                                        <i data-feather="star" class="star-half"></i>
                                                    <?php else: ?>
                                                        <i data-feather="star"></i>
                                                    <?php endif;
                                                endfor; 
                                                ?>
                                            </div>
                                            <p class="rating-count"><?= __('Based on %1 reviews', $reviewCount) ?></p>
                                        </div>
                                    </div>
                                    
                                    <a href="#review-form" class="btn-write-review" onclick="document.getElementById('review-form').scrollIntoView({behavior: 'smooth'}); return false;">
                                        <i data-feather="edit-3"></i>
                                        <?= __('WRITE A REVIEW') ?>
                                    </a>
                                </div>
                                
                                <!-- Reviews List -->
                                <?php if ($reviewCollection && $reviewCollection->count() > 0): ?>
                                <div class="reviews-list">
                                    <?php 
                                    foreach ($reviewCollection as $_review): 
                                        $ratingVotes = null;
                                        $ratingValue = 0;
                                        try {
                                            $ratingFactory = $objectManager->get(\Magento\Review\Model\RatingFactory::class);
                                            $ratingCollection = $ratingFactory->create()
                                                ->getResourceCollection()
                                                ->addEntityFilter('product')
                                                ->setStoreFilter($objectManager->get(\Magento\Store\Model\StoreManagerInterface::class)->getStore()->getId())
                                                ->addRatingPerStoreName($objectManager->get(\Magento\Store\Model\StoreManagerInterface::class)->getStore()->getId())
                                                ->setPositionOrder();
                                            
                                            $ratingVotes = $ratingCollection->getItemByColumnValue('review_id', $_review->getId());
                                            if ($ratingVotes) {
                                                $ratingValue = round($ratingVotes->getSum() / $ratingVotes->getCount() / 20, 0); // Convert to 5-star scale
                                            }
                                        } catch (\Exception $e) {
                                            // Rating not available
                                            $ratingValue = 0;
                                        }
                                    ?>
                                    <div class="review-item">
                                        <div class="review-header">
                                            <div class="reviewer-info">
                                                <strong class="reviewer-name"><?= $block->escapeHtml($_review->getNickname()) ?></strong>
                                                <div class="review-stars">
                                                    <?php 
                                                    for ($i = 1; $i <= 5; $i++): 
                                                        if ($i <= $ratingValue): ?>
                                                            <i data-feather="star" class="star-filled"></i>
                                                        <?php else: ?>
                                                            <i data-feather="star"></i>
                                                        <?php endif;
                                                    endfor; 
                                                    ?>
                                                </div>
                                            </div>
                                            <span class="review-date"><?= $block->escapeHtml($block->formatDate($_review->getCreatedAt(), \IntlDateFormatter::LONG, false)) ?></span>
                                        </div>
                                        <?php if ($_review->getTitle()): ?>
                                        <h4 class="review-title"><?= $block->escapeHtml($_review->getTitle()) ?></h4>
                                        <?php endif; ?>
                                        <p class="review-text"><?= $block->escapeHtml(nl2br($_review->getDetail())) ?></p>
                                    </div>
                                    <?php endforeach; ?>
                                </div>
                                
                                <?php if ($reviewCollection->getSize() > $reviewCollection->getPageSize()): ?>
                                <div class="text-center mt-5">
                                    <button class="btn-load-more-reviews" onclick="loadMoreReviews(2)"><?= __('LOAD MORE REVIEWS') ?></button>
                                </div>
                                <?php endif; ?>
                                <?php endif; ?>
                            <?php else: ?>
                                <div class="reviews-summary">
                                    <p><?= __('No reviews yet. Be the first to review this product!') ?></p>
                                    <a href="#review-form" class="btn-write-review" onclick="document.getElementById('review-form').scrollIntoView({behavior: 'smooth'}); return false;">
                                        <i data-feather="edit-3"></i>
                                        <?= __('WRITE A REVIEW') ?>
                                    </a>
                                </div>
                            <?php endif; ?>
                            
                            <!-- Magento Review Form -->
                            <div id="review-form">
                                <?= $block->getChildHtml('product.info.review') ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: Decorative Image -->
            <div class="col-lg-4">
                <div class="tabs-image-wrapper">
                    <?php 
                    $imageHelper = $this->helper('Magento\Catalog\Helper\Image');
                    // Try to get a secondary image from gallery, or use main image
                    $decorativeImage = '';
                    try {
                        $galleryImages = $_product->getMediaGalleryImages();
                        if ($galleryImages && $galleryImages->count() > 1) {
                            // Get the second image (index 1)
                            $galleryArray = $galleryImages->toArray();
                            $images = isset($galleryArray['items']) ? $galleryArray['items'] : [];
                            if (count($images) > 1 && isset($images[1]['file'])) {
                                $decorativeImage = $imageHelper->init($_product, 'product_page_image_large')
                                    ->setImageFile($images[1]['file'])
                                    ->getUrl();
                            } else {
                                $decorativeImage = $imageHelper->init($_product, 'product_page_image_large')->getUrl();
                            }
                        } else {
                            $decorativeImage = $imageHelper->init($_product, 'product_page_image_large')->getUrl();
                        }
                    } catch (\Exception $e) {
                        $decorativeImage = $imageHelper->init($_product, 'product_page_image_large')->getUrl();
                    }
                    
                    if (empty($decorativeImage)) {
                        $decorativeImage = $imageHelper->init($_product, 'product_page_image_large')->getUrl();
                    }
                    ?>
                    <img src="<?= $block->escapeUrl($decorativeImage) ?>" 
                         alt="<?= $block->escapeHtmlAttr($_product->getName()) ?>" 
                         class="tabs-decorative-image">
                </div>
            </div>
        </div>
    </div>
</section>

<script>
require(['jquery', 'mage/url'], function($, urlBuilder) {
    // Tab switching
    $('.tab-btn-vertical').on('click', function() {
        var tabId = $(this).data('tab');
        
        // Update buttons
        $('.tab-btn-vertical').removeClass('active');
        $(this).addClass('active');
        
        // Update panes
        $('.tab-pane').removeClass('active');
        $('#' + tabId).addClass('active');
        
        // Reinitialize feather icons after tab switch
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
    
    // Load More Reviews function
    window.loadMoreReviews = function(page) {
        require(['jquery', 'mage/url'], function($, urlBuilder) {
            var productId = '<?= $_product->getId() ?>';
            var url = urlBuilder.build('review/product/listAjax/id/' + productId + '/p/' + page);
            
            $.ajax({
                url: url,
                type: 'GET',
                dataType: 'html',
                showLoader: true,
                success: function(response) {
                    $('.reviews-list').append(response);
                    
                    // Check if there are more reviews
                    if ($(response).find('.review-item').length < 5) {
                        $('.btn-load-more-reviews').hide();
                    } else {
                        $('.btn-load-more-reviews').attr('onclick', 'loadMoreReviews(' + (page + 1) + ')');
                    }
                    
                    // Reinitialize feather icons
                    if (typeof feather !== 'undefined') {
                        feather.replace();
                    }
                },
                error: function() {
                    $('.btn-load-more-reviews').hide();
                }
            });
        });
    };
    
    // Initialize feather icons on page load
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});
</script>

