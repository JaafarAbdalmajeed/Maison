<?php
/**
 * Product Gallery Template - Custom Design
 * @var \Magento\Catalog\Block\Product\View\Gallery $block
 */
$_product = $block->getProduct();
if (!$_product) {
    return;
}

// Safely get gallery images
$images = [];
try {
    $galleryImages = $block->getGalleryImages();
    if ($galleryImages && (is_array($galleryImages) || $galleryImages instanceof \Traversable)) {
        $images = $galleryImages;
    }
} catch (\Exception $e) {
    // If getGalleryImages fails, use empty array
    $images = [];
}
$imageHelper = $this->helper('Magento\Catalog\Helper\Image');
if (!$imageHelper) {
    $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
    $imageHelper = $objectManager->get(\Magento\Catalog\Helper\Image::class);
}

// Get main image - use image helper directly (more reliable)
$mainImageUrl = '';
$mainImageLabel = $_product->getName();

try {
    if ($imageHelper && $_product) {
        $imageObject = $imageHelper->init($_product, 'product_page_image_large');
        // Check if init returned a valid object
        if ($imageObject && is_object($imageObject) && method_exists($imageObject, 'getUrl')) {
            $mainImageUrl = $imageObject->getUrl();
            $mainImageLabel = $_product->getName();
        } else {
            throw new \Exception('Image helper init failed');
        }
    } else {
        throw new \Exception('Image helper or product not available');
    }
} catch (\Exception $e) {
    // Fallback: try to get placeholder
    try {
        if ($imageHelper && method_exists($imageHelper, 'getDefaultPlaceholderUrl')) {
            $mainImageUrl = $imageHelper->getDefaultPlaceholderUrl('image');
        } else {
            // Last resort: use a default placeholder path
            $mainImageUrl = $block->getViewFileUrl('images/placeholder/image.jpg');
        }
    } catch (\Exception $e2) {
        // Absolute last resort
        $mainImageUrl = $block->getViewFileUrl('images/placeholder/image.jpg');
    }
}

// Ensure we have a valid URL
if (empty($mainImageUrl)) {
    try {
        if ($imageHelper && method_exists($imageHelper, 'getDefaultPlaceholderUrl')) {
            $mainImageUrl = $imageHelper->getDefaultPlaceholderUrl('image');
        } else {
            $mainImageUrl = $block->getViewFileUrl('images/placeholder/image.jpg');
        }
    } catch (\Exception $e) {
        $mainImageUrl = $block->getViewFileUrl('images/placeholder/image.jpg');
    }
}
?>
<div class="product-images-gallery">
    <!-- Main Image -->
    <div class="main-image-container">
        <img src="<?= $block->escapeUrl($mainImageUrl) ?>" 
             alt="<?= $block->escapeHtmlAttr($mainImageLabel) ?>" 
             id="mainImage" 
             class="main-product-image">
        
        <?php
        // Product Badge (Bestseller or New)
        $isBestseller = false;
        $isNew = false;
        
        try {
            $bestsellerValue = $_product->getAttributeText('bestseller');
            $isBestseller = !empty($bestsellerValue) && ($bestsellerValue !== false && $bestsellerValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist or error, ignore
        }
        
        try {
            $newValue = $_product->getAttributeText('new');
            $isNew = !empty($newValue) && ($newValue !== false && $newValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist or error, ignore
        }
        
        if ($isBestseller): ?>
            <div class="product-badge-detail"><?= __('BEST SELLER') ?></div>
        <?php elseif ($isNew): ?>
            <div class="product-badge-detail" style="background-color: var(--primary-gold);"><?= __('NEW') ?></div>
        <?php endif; ?>
        
        <button class="zoom-button" id="zoomBtn">
            <i data-feather="maximize-2"></i>
        </button>
    </div>
    
    <!-- Thumbnail Gallery -->
    <?php if (count($images) > 1): ?>
    <div class="thumbnails-gallery">
        <button class="thumbnail-nav prev" onclick="scrollThumbnails(-1)">
            <i data-feather="chevron-left"></i>
        </button>
        <div class="thumbnails-container" id="thumbnailsContainer">
            <?php 
            $first = true;
            foreach ($images as $image): 
                $thumbnailUrl = '';
                $largeUrl = '';
                try {
                    if (!$imageHelper || !$_product || !$image) {
                        continue; // Skip if no image helper, product, or image
                    }
                    
                    // Check if image is an object and has getFile method
                    if (!is_object($image) || !method_exists($image, 'getFile')) {
                        continue; // Skip if image is not a valid object
                    }
                    
                    $imageFile = $image->getFile();
                    if (empty($imageFile) || !is_string($imageFile)) {
                        continue; // Skip if no file or invalid file
                    }
                    
                    // Get thumbnail image
                    $thumbnailImage = $imageHelper->init($_product, 'product_page_image_small')
                        ->setImageFile($imageFile);
                    
                    // Check if thumbnail init was successful
                    if ($thumbnailImage && is_object($thumbnailImage) && method_exists($thumbnailImage, 'getUrl')) {
                        $thumbnailUrl = $thumbnailImage->getUrl();
                    } else {
                        continue; // Skip if thumbnail failed
                    }
                    
                    // Get large image
                    $largeImage = $imageHelper->init($_product, 'product_page_image_large')
                        ->setImageFile($imageFile);
                    
                    // Check if large init was successful
                    if ($largeImage && is_object($largeImage) && method_exists($largeImage, 'getUrl')) {
                        $largeUrl = $largeImage->getUrl();
                    } else {
                        continue; // Skip if large image failed
                    }
                } catch (\Exception $e) {
                    continue; // Skip on error
                } catch (\Throwable $e) {
                    continue; // Skip on any throwable
                }
                
                // Only render if we have valid URLs
                if (!empty($thumbnailUrl) && !empty($largeUrl)):
            ?>
                <img src="<?= $block->escapeUrl($thumbnailUrl) ?>" 
                     alt="<?= $block->escapeHtmlAttr($image->getLabel() ?: $_product->getName()) ?>" 
                     class="thumbnail <?= $first ? 'active' : '' ?>" 
                     data-image="<?= $block->escapeUrl($largeUrl) ?>"
                     onclick="changeMainImage('<?= $block->escapeJs($largeUrl) ?>', this)">
            <?php 
                    $first = false;
                endif;
            endforeach; 
            ?>
        </div>
        <button class="thumbnail-nav next" onclick="scrollThumbnails(1)">
            <i data-feather="chevron-right"></i>
        </button>
    </div>
    <?php endif; ?>
</div>

<script>
function changeMainImage(imageUrl, thumbnail) {
    document.getElementById('mainImage').src = imageUrl;
    document.querySelectorAll('.thumbnail').forEach(function(thumb) {
        thumb.classList.remove('active');
    });
    thumbnail.classList.add('active');
}

function scrollThumbnails(direction) {
    const container = document.getElementById('thumbnailsContainer');
    const scrollAmount = 200;
    container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
    });
}
</script>

