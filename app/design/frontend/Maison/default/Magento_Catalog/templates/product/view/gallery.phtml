<?php
/**
 * Product Gallery Template - Custom Design
 * @var \Magento\Catalog\Block\Product\View\Gallery $block
 */
$_product = $block->getProduct();
if (!$_product) {
    return;
}

$images = $block->getGalleryImages() ?: [];
$imageHelper = $this->helper('Magento\Catalog\Helper\Image');
if (!$imageHelper) {
    $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
    $imageHelper = $objectManager->get(\Magento\Catalog\Helper\Image::class);
}

// Get main image - use image helper directly (more reliable)
$mainImageUrl = '';
$mainImageLabel = $_product->getName();

try {
    if ($imageHelper) {
        $mainImageUrl = $imageHelper->init($_product, 'product_page_image_large')->getUrl();
        $mainImageLabel = $_product->getName();
    } else {
        throw new \Exception('Image helper not available');
    }
} catch (\Exception $e) {
    // Fallback: try to get placeholder
    try {
        if ($imageHelper) {
            $mainImageUrl = $imageHelper->getDefaultPlaceholderUrl('image');
        } else {
            // Last resort: use a default placeholder path
            $mainImageUrl = '/static/frontend/Maison/default/images/placeholder/image.jpg';
        }
    } catch (\Exception $e2) {
        // Absolute last resort
        $mainImageUrl = '/static/frontend/Maison/default/images/placeholder/image.jpg';
    }
}

// Ensure we have a valid URL
if (empty($mainImageUrl)) {
    try {
        if ($imageHelper) {
            $mainImageUrl = $imageHelper->getDefaultPlaceholderUrl('image');
        } else {
            $mainImageUrl = '/static/frontend/Maison/default/images/placeholder/image.jpg';
        }
    } catch (\Exception $e) {
        $mainImageUrl = '/static/frontend/Maison/default/images/placeholder/image.jpg';
    }
}
?>
<div class="product-images-gallery">
    <!-- Main Image -->
    <div class="main-image-container">
        <img src="<?= $block->escapeUrl($mainImageUrl) ?>" 
             alt="<?= $block->escapeHtmlAttr($mainImageLabel) ?>" 
             id="mainImage" 
             class="main-product-image">
        
        <?php
        // Product Badge (Bestseller or New)
        $isBestseller = $_product->getAttributeText('bestseller');
        $isNew = $_product->getAttributeText('new');
        if ($isBestseller): ?>
            <div class="product-badge-detail"><?= __('BEST SELLER') ?></div>
        <?php elseif ($isNew): ?>
            <div class="product-badge-detail" style="background-color: var(--primary-gold);"><?= __('NEW') ?></div>
        <?php endif; ?>
        
        <button class="zoom-button" id="zoomBtn">
            <i data-feather="maximize-2"></i>
        </button>
    </div>
    
    <!-- Thumbnail Gallery -->
    <?php if (count($images) > 1): ?>
    <div class="thumbnails-gallery">
        <button class="thumbnail-nav prev" onclick="scrollThumbnails(-1)">
            <i data-feather="chevron-left"></i>
        </button>
        <div class="thumbnails-container" id="thumbnailsContainer">
            <?php 
            $first = true;
            foreach ($images as $image): 
                $thumbnailUrl = '';
                $largeUrl = '';
                try {
                    if (!$imageHelper) {
                        continue; // Skip if no image helper
                    }
                    $imageFile = $image->getFile();
                    if ($imageFile && $imageHelper) {
                        $thumbnailUrl = $imageHelper->init($_product, 'product_page_image_small')
                            ->setImageFile($imageFile)
                            ->getUrl();
                        $largeUrl = $imageHelper->init($_product, 'product_page_image_large')
                            ->setImageFile($imageFile)
                            ->getUrl();
                    } else {
                        continue; // Skip if no file
                    }
                } catch (\Exception $e) {
                    continue; // Skip on error
                }
                
                // Only render if we have valid URLs
                if (!empty($thumbnailUrl) && !empty($largeUrl)):
            ?>
                <img src="<?= $block->escapeUrl($thumbnailUrl) ?>" 
                     alt="<?= $block->escapeHtmlAttr($image->getLabel() ?: $_product->getName()) ?>" 
                     class="thumbnail <?= $first ? 'active' : '' ?>" 
                     data-image="<?= $block->escapeUrl($largeUrl) ?>"
                     onclick="changeMainImage('<?= $block->escapeJs($largeUrl) ?>', this)">
            <?php 
                    $first = false;
                endif;
            endforeach; 
            ?>
        </div>
        <button class="thumbnail-nav next" onclick="scrollThumbnails(1)">
            <i data-feather="chevron-right"></i>
        </button>
    </div>
    <?php endif; ?>
</div>

<script>
function changeMainImage(imageUrl, thumbnail) {
    document.getElementById('mainImage').src = imageUrl;
    document.querySelectorAll('.thumbnail').forEach(function(thumb) {
        thumb.classList.remove('active');
    });
    thumbnail.classList.add('active');
}

function scrollThumbnails(direction) {
    const container = document.getElementById('thumbnailsContainer');
    const scrollAmount = 200;
    container.scrollBy({
        left: direction * scrollAmount,
        behavior: 'smooth'
    });
}
</script>

