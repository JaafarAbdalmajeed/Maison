<?php
/**
 * Product Info Template - Custom Design
 * @var \Magento\Catalog\Block\Product\View $block
 */
$_product = $block->getProduct();
$_helper = $this->helper('Magento\Catalog\Helper\Output');
$priceHelper = $this->helper('Magento\Framework\Pricing\Helper\Data');
$wishlistHelper = $this->helper('Magento\Wishlist\Helper\Data');
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->get('Magento\Store\Model\StoreManagerInterface');
$baseUrl = $storeManager->getStore()->getBaseUrl();

// Safely get review summary
$ratingSummary = null;
$rating = 0;
$reviewCount = 0;
try {
    $reviewFactory = $objectManager->get(\Magento\Review\Model\ReviewFactory::class);
    $review = $reviewFactory->create();
    $review->getEntitySummary($_product);
    $ratingSummary = $_product->getRatingSummary();
    if ($ratingSummary) {
        $rating = $ratingSummary->getRatingSummary() ? ($ratingSummary->getRatingSummary() / 20) : 0; // Convert to 5-star scale
        $reviewCount = $ratingSummary->getReviewsCount() ?: 0;
    }
} catch (\Exception $e) {
    // Reviews not available, use defaults
    $rating = 0;
    $reviewCount = 0;
} catch (\Throwable $e) {
    // Reviews not available, use defaults
    $rating = 0;
    $reviewCount = 0;
}
?>

<div class="product-info-section">
    <!-- Brand -->
    <?php 
    $manufacturer = $_product->getAttributeText('manufacturer');
    if ($manufacturer): ?>
        <div class="product-brand-detail"><?= $block->escapeHtml($manufacturer) ?></div>
    <?php endif; ?>
    
    <!-- Product Title -->
    <h1 class="product-title-detail"><?= $block->escapeHtml($_product->getName()) ?></h1>
    
    <!-- Rating & Reviews -->
    <?php if ($ratingSummary && $reviewCount > 0): ?>
    <div class="product-rating">
        <div class="stars">
            <?php 
            $fullStars = floor($rating);
            $hasHalfStar = ($rating - $fullStars) >= 0.5;
            for ($i = 1; $i <= 5; $i++): 
                if ($i <= $fullStars): ?>
                    <i data-feather="star" class="star-filled"></i>
                <?php elseif ($i == $fullStars + 1 && $hasHalfStar): ?>
                    <i data-feather="star" class="star-half"></i>
                <?php else: ?>
                    <i data-feather="star"></i>
                <?php endif;
            endfor; 
            ?>
        </div>
        <span class="rating-text">(<?= $block->escapeHtml($reviewCount) ?> <?= __('Reviews') ?>)</span>
    </div>
    <?php endif; ?>
    
    <!-- Price -->
    <div class="product-price-detail">
        <?php 
        $finalPrice = $_product->getFinalPrice();
        $regularPrice = $_product->getPrice();
        $priceHtml = $block->getProductPrice($_product);
        ?>
        <span class="current-price"><?= $priceHtml ?></span>
        <?php if ($regularPrice > $finalPrice): 
            $discountPercent = round((($regularPrice - $finalPrice) / $regularPrice) * 100);
        ?>
            <span class="original-price"><?= $block->getProductPrice($_product, \Magento\Catalog\Pricing\Price\RegularPrice::PRICE_CODE) ?></span>
            <span class="discount-badge">-<?= $discountPercent ?>%</span>
        <?php endif; ?>
    </div>
    
    <!-- Short Description -->
    <?php if ($_product->getShortDescription()): ?>
        <p class="product-short-description">
            <?= $_helper->productAttribute($_product, $_product->getShortDescription(), 'short_description') ?>
        </p>
    <?php endif; ?>
    
    <div class="divider-gold"></div>
    
    <!-- Add to Cart Form (includes Product Options & Quantity) -->
    <div class="product-actions-detail">
        <?= $block->getChildHtml('product.info.addtocart') ?>
        
        <?php if ($wishlistHelper->isAllow()): ?>
            <a href="#" 
               class="btn-wishlist-detail" 
               data-post='<?= $block->getAddToWishlistParams($_product) ?>'
               data-action="add-to-wishlist"
               title="<?= __('Add to Wish List') ?>">
                <i data-feather="heart"></i>
            </a>
        <?php endif; ?>
    </div>
    
    <!-- Trust Badges -->
    <div class="trust-badges-detail">
        <div class="trust-badge-item">
            <i data-feather="truck"></i>
            <div class="trust-badge-text">
                <strong><?= __('Free Delivery') ?></strong>
                <span><?= __('White Glove Service') ?></span>
            </div>
        </div>
        <div class="trust-badge-item">
            <i data-feather="shield"></i>
            <div class="trust-badge-text">
                <strong><?= __('2-Year Warranty') ?></strong>
                <span><?= __('Extended Protection') ?></span>
            </div>
        </div>
        <div class="trust-badge-item">
            <i data-feather="award"></i>
            <div class="trust-badge-text">
                <strong><?= __('100% Authentic') ?></strong>
                <span><?= __('Guaranteed Genuine') ?></span>
            </div>
        </div>
    </div>
    
    <!-- Additional Info -->
    <div class="product-meta-detail">
        <div class="meta-item">
            <span class="meta-label"><?= __('SKU') ?>:</span>
            <span class="meta-value"><?= $block->escapeHtml($_product->getSku()) ?></span>
        </div>
        <?php 
        $categories = $_product->getCategoryCollection()->addAttributeToSelect('name');
        if ($categories->count() > 0): ?>
        <div class="meta-item">
            <span class="meta-label"><?= __('Category') ?>:</span>
            <span class="meta-value">
                <?php 
                $categoryLinks = [];
                foreach ($categories as $category):
                    $categoryLinks[] = '<a href="' . $block->escapeUrl($category->getUrl()) . '">' . $block->escapeHtml($category->getName()) . '</a>';
                endforeach;
                echo implode(', ', $categoryLinks);
                ?>
            </span>
        </div>
        <?php endif; ?>
        <?php 
        // Get product tags
        try {
            $tagCollection = null;
            if (class_exists('\Magento\Tag\Model\ResourceModel\Tag\CollectionFactory')) {
                $tagCollectionFactory = $objectManager->get(\Magento\Tag\Model\ResourceModel\Tag\CollectionFactory::class);
                $tagCollection = $tagCollectionFactory->create();
                $tagCollection->addPopularity()
                    ->addStatusFilter(\Magento\Tag\Model\Tag::STATUS_APPROVED)
                    ->addProductFilter($_product->getId())
                    ->setFlag('relation', true)
                    ->addStoreFilter($storeManager->getStore()->getId())
                    ->setActiveFilter();
            }
            
            if ($tagCollection && $tagCollection->count() > 0):
                $tagNames = [];
                foreach ($tagCollection as $tag):
                    $tagNames[] = $block->escapeHtml($tag->getName());
                endforeach;
                if (!empty($tagNames)): ?>
                <div class="meta-item">
                    <span class="meta-label"><?= __('Tags') ?>:</span>
                    <span class="meta-value"><?= implode(', ', $tagNames) ?></span>
                </div>
                <?php endif;
            endif;
        } catch (\Exception $e) {
            // Tags not available, skip
        } catch (\Throwable $e) {
            // Tags not available, skip
        }
        ?>
    </div>
    
    <!-- Share -->
    <div class="product-share">
        <span class="share-label"><?= __('SHARE') ?>:</span>
        <?php 
        $productUrl = $block->escapeUrl($_product->getProductUrl());
        $productName = $block->escapeUrl($_product->getName());
        ?>
        <a href="https://www.facebook.com/sharer/sharer.php?u=<?= urlencode($productUrl) ?>" 
           target="_blank" 
           class="share-link">
            <i data-feather="facebook"></i>
        </a>
        <a href="https://twitter.com/intent/tweet?url=<?= urlencode($productUrl) ?>&text=<?= urlencode($productName) ?>" 
           target="_blank" 
           class="share-link">
            <i data-feather="twitter"></i>
        </a>
        <a href="https://www.instagram.com/" 
           target="_blank" 
           class="share-link">
            <i data-feather="instagram"></i>
        </a>
        <a href="mailto:?subject=<?= urlencode($productName) ?>&body=<?= urlencode($productUrl) ?>" 
           class="share-link">
            <i data-feather="mail"></i>
        </a>
    </div>
</div>

<script>
require(['jquery', 'domReady!'], function($) {
    // Function to enable Add to Cart button
    function enableAddToCartButton() {
        var addToCartButton = $('#product-addtocart-button, .action.tocart, button[type="submit"].tocart');
        if (addToCartButton.length) {
            // Remove disabled attribute
            addToCartButton.prop('disabled', false);
            addToCartButton.removeAttr('disabled');
            
            // Ensure button is clickable
            addToCartButton.css({
                'pointer-events': 'auto',
                'opacity': '1',
                'cursor': 'pointer'
            });
            
            // Remove disabled class if exists
            addToCartButton.removeClass('disabled');
            
            // Ensure button has click handler
            addToCartButton.off('click.addtocart').on('click.addtocart', function(e) {
                var $form = $(this).closest('form[data-role="tocart-form"]');
                if ($form.length && $form[0].checkValidity()) {
                    // Form is valid, let Magento handle submission
                    return true;
                } else {
                    e.preventDefault();
                    $form[0].reportValidity();
                    return false;
                }
            });
        }
    }
    
    // Quantity controls for custom quantity input if exists
    $(document).on('click', '#qtyPlus', function(e) {
        e.preventDefault();
        var qtyInput = $('#qty, input[name="qty"]').first();
        if (!qtyInput.length) qtyInput = $('#qtyInput');
        var currentVal = parseInt(qtyInput.val()) || 1;
        if (currentVal < 9999) {
            qtyInput.val(currentVal + 1).trigger('change');
        }
    });
    
    $(document).on('click', '#qtyMinus', function(e) {
        e.preventDefault();
        var qtyInput = $('#qty, input[name="qty"]').first();
        if (!qtyInput.length) qtyInput = $('#qtyInput');
        var currentVal = parseInt(qtyInput.val()) || 1;
        if (currentVal > 1) {
            qtyInput.val(currentVal - 1).trigger('change');
        }
    });
    
    // Initialize after page load
    setTimeout(function() {
        enableAddToCartButton();
        
        // Watch for changes in product options
        $(document).on('change', '.product-options-wrapper select, .product-options-wrapper input', function() {
            setTimeout(function() {
                enableAddToCartButton();
            }, 100);
        });
        
        // Monitor for any code that tries to disable the button
        var addToCartButton = $('#product-addtocart-button');
        if (addToCartButton.length) {
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'disabled') {
                        var target = $(mutation.target);
                        if (target.is('#product-addtocart-button, .action.tocart')) {
                            if (target.prop('disabled')) {
                                setTimeout(function() {
                                    enableAddToCartButton();
                                }, 50);
                            }
                        }
                    }
                });
            });
            
            observer.observe(addToCartButton[0], {
                attributes: true,
                attributeFilter: ['disabled', 'class']
            });
        }
    }, 500);
    
    // Also enable on page fully loaded
    $(window).on('load', function() {
        setTimeout(function() {
            enableAddToCartButton();
        }, 1000);
    });
});
</script>

