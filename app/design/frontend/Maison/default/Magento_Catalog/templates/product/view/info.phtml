<?php
/**
 * Product Info Template - Custom Design
 * @var \Magento\Catalog\Block\Product\View $block
 */
$_product = $block->getProduct();
$_helper = $this->helper('Magento\Catalog\Helper\Output');
$priceHelper = $this->helper('Magento\Framework\Pricing\Helper\Data');
$wishlistHelper = $this->helper('Magento\Wishlist\Helper\Data');
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$storeManager = $objectManager->get('Magento\Store\Model\StoreManagerInterface');
$baseUrl = $storeManager->getStore()->getBaseUrl();

// Safely get review summary
$ratingSummary = null;
$rating = 0;
$reviewCount = 0;
try {
    $reviewFactory = $objectManager->get(\Magento\Review\Model\ReviewFactory::class);
    $review = $reviewFactory->create();
    $review->getEntitySummary($_product);
    $ratingSummary = $_product->getRatingSummary();
    if ($ratingSummary) {
        $rating = $ratingSummary->getRatingSummary() ? ($ratingSummary->getRatingSummary() / 20) : 0; // Convert to 5-star scale
        $reviewCount = $ratingSummary->getReviewsCount() ?: 0;
    }
} catch (\Exception $e) {
    // Reviews not available, use defaults
    $rating = 0;
    $reviewCount = 0;
} catch (\Throwable $e) {
    // Reviews not available, use defaults
    $rating = 0;
    $reviewCount = 0;
}
?>

<div class="product-info-section">
    <!-- Brand -->
    <?php 
    $manufacturer = $_product->getAttributeText('manufacturer');
    if ($manufacturer): ?>
        <div class="product-brand-detail"><?= $block->escapeHtml($manufacturer) ?></div>
    <?php endif; ?>
    
    <!-- Product Title -->
    <h1 class="product-title-detail"><?= $block->escapeHtml($_product->getName()) ?></h1>
    
    <!-- Rating & Reviews -->
    <?php if ($ratingSummary && $reviewCount > 0): ?>
    <div class="product-rating">
        <div class="stars">
            <?php 
            $fullStars = floor($rating);
            $hasHalfStar = ($rating - $fullStars) >= 0.5;
            for ($i = 1; $i <= 5; $i++): 
                if ($i <= $fullStars): ?>
                    <i data-feather="star" class="star-filled"></i>
                <?php elseif ($i == $fullStars + 1 && $hasHalfStar): ?>
                    <i data-feather="star" class="star-half"></i>
                <?php else: ?>
                    <i data-feather="star"></i>
                <?php endif;
            endfor; 
            ?>
        </div>
        <span class="rating-text">(<?= $block->escapeHtml($reviewCount) ?> <?= __('Reviews') ?>)</span>
    </div>
    <?php endif; ?>
    
    <!-- Price -->
    <div class="product-price-detail">
        <?php 
        $finalPrice = $_product->getFinalPrice();
        $regularPrice = $_product->getPrice();
        $priceHtml = $block->getProductPrice($_product);
        ?>
        <span class="current-price"><?= $priceHtml ?></span>
        <?php if ($regularPrice > $finalPrice): 
            $discountPercent = round((($regularPrice - $finalPrice) / $regularPrice) * 100);
        ?>
            <span class="original-price"><?= $block->getProductPrice($_product, \Magento\Catalog\Pricing\Price\RegularPrice::PRICE_CODE) ?></span>
            <span class="discount-badge">-<?= $discountPercent ?>%</span>
        <?php endif; ?>
    </div>
    
    <!-- Short Description -->
    <?php if ($_product->getShortDescription()): ?>
        <p class="product-short-description">
            <?= $_helper->productAttribute($_product, $_product->getShortDescription(), 'short_description') ?>
        </p>
    <?php endif; ?>
    
    <div class="divider-gold"></div>
    
    <!-- Product Options -->
    <div class="product-options-section">
        <?= $block->getChildHtml('product.info.options') ?>
        
        <!-- Quantity -->
        <div class="option-group-detail">
            <label class="option-label-detail"><?= __('Quantity') ?></label>
            <div class="quantity-selector-detail">
                <button class="qty-btn-detail qty-minus" id="qtyMinus">-</button>
                <input type="number" 
                       class="qty-input-detail" 
                       value="1" 
                       min="1" 
                       max="99" 
                       id="qtyInput"
                       name="qty">
                <button class="qty-btn-detail qty-plus" id="qtyPlus">+</button>
            </div>
        </div>
    </div>
    
    <!-- Add to Cart & Wishlist -->
    <div class="product-actions-detail">
        <?= $block->getChildHtml('product.info.addtocart') ?>
        
        <?php if ($wishlistHelper->isAllow()): ?>
            <a href="#" 
               class="btn-wishlist-detail" 
               data-post='<?= $block->getAddToWishlistParams($_product) ?>'
               data-action="add-to-wishlist"
               title="<?= __('Add to Wish List') ?>">
                <i data-feather="heart"></i>
            </a>
        <?php endif; ?>
    </div>
    
    <!-- Trust Badges -->
    <div class="trust-badges-detail">
        <div class="trust-badge-item">
            <i data-feather="truck"></i>
            <div class="trust-badge-text">
                <strong><?= __('Free Delivery') ?></strong>
                <span><?= __('White Glove Service') ?></span>
            </div>
        </div>
        <div class="trust-badge-item">
            <i data-feather="shield"></i>
            <div class="trust-badge-text">
                <strong><?= __('2-Year Warranty') ?></strong>
                <span><?= __('Extended Protection') ?></span>
            </div>
        </div>
        <div class="trust-badge-item">
            <i data-feather="award"></i>
            <div class="trust-badge-text">
                <strong><?= __('100% Authentic') ?></strong>
                <span><?= __('Guaranteed Genuine') ?></span>
            </div>
        </div>
    </div>
    
    <!-- Additional Info -->
    <div class="product-meta-detail">
        <div class="meta-item">
            <span class="meta-label"><?= __('SKU') ?>:</span>
            <span class="meta-value"><?= $block->escapeHtml($_product->getSku()) ?></span>
        </div>
        <?php 
        $categories = $_product->getCategoryCollection()->addAttributeToSelect('name');
        if ($categories->count() > 0): ?>
        <div class="meta-item">
            <span class="meta-label"><?= __('Category') ?>:</span>
            <span class="meta-value">
                <?php 
                $categoryLinks = [];
                foreach ($categories as $category):
                    $categoryLinks[] = '<a href="' . $block->escapeUrl($category->getUrl()) . '">' . $block->escapeHtml($category->getName()) . '</a>';
                endforeach;
                echo implode(', ', $categoryLinks);
                ?>
            </span>
        </div>
        <?php endif; ?>
    </div>
    
    <!-- Share -->
    <div class="product-share">
        <span class="share-label"><?= __('SHARE') ?>:</span>
        <?php 
        $productUrl = $block->escapeUrl($_product->getProductUrl());
        $productName = $block->escapeUrl($_product->getName());
        ?>
        <a href="https://www.facebook.com/sharer/sharer.php?u=<?= urlencode($productUrl) ?>" 
           target="_blank" 
           class="share-link">
            <i data-feather="facebook"></i>
        </a>
        <a href="https://twitter.com/intent/tweet?url=<?= urlencode($productUrl) ?>&text=<?= urlencode($productName) ?>" 
           target="_blank" 
           class="share-link">
            <i data-feather="twitter"></i>
        </a>
        <a href="https://www.instagram.com/" 
           target="_blank" 
           class="share-link">
            <i data-feather="instagram"></i>
        </a>
        <a href="mailto:?subject=<?= urlencode($productName) ?>&body=<?= urlencode($productUrl) ?>" 
           class="share-link">
            <i data-feather="mail"></i>
        </a>
    </div>
</div>

<script>
require(['jquery'], function($) {
    // Quantity controls
    $('#qtyPlus').on('click', function() {
        var qtyInput = $('#qtyInput');
        var currentVal = parseInt(qtyInput.val());
        if (currentVal < 99) {
            qtyInput.val(currentVal + 1);
        }
    });
    
    $('#qtyMinus').on('click', function() {
        var qtyInput = $('#qtyInput');
        var currentVal = parseInt(qtyInput.val());
        if (currentVal > 1) {
            qtyInput.val(currentVal - 1);
        }
    });
});
</script>

