<?php
/**
 * Product List Item Template - Matching Design
 * @var \Magento\Framework\View\Element\Template $block
 */
use Magento\Framework\App\Action\Action;

// Get product from parent block (ListProduct)
$_product = $block->getData('product');
if (!$_product) {
    return;
}

// Get helper and parent block
$_helper = $block->getData('outputHelper');
$parentBlock = $block->getParentBlock();
$imageDisplayArea = 'category_page_grid';
$pos = $parentBlock ? $parentBlock->getPositioned() : null;
?>
<div class="product-card product-item" data-container="product-grid">
    <?php
    $productImage = $block->getImage($_product, $imageDisplayArea);
    ?>
    
    <!-- Product Image Wrapper -->
    <div class="product-image-wrapper">
        <a href="<?= $block->escapeUrl($_product->getProductUrl()) ?>" 
           class="product-image-link"
           title="<?= $block->escapeHtmlAttr($_product->getName()) ?>">
            <?php
            $productImage = $parentBlock ? $parentBlock->getImage($_product, $imageDisplayArea) : null;
            if ($productImage) {
                echo $productImage->toHtml();
            }
            ?>
        </a>
        
        <?php
        // Product Badge (if bestseller or new) - Safely check
        $isBestseller = false;
        $isNew = false;
        
        try {
            $bestsellerValue = $_product->getAttributeText('bestseller');
            $isBestseller = !empty($bestsellerValue) && ($bestsellerValue !== false && $bestsellerValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        
        try {
            $newValue = $_product->getAttributeText('new');
            $isNew = !empty($newValue) && ($newValue !== false && $newValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        
        if ($isBestseller): ?>
            <div class="product-badge"><?= __('BEST SELLER') ?></div>
        <?php elseif ($isNew): ?>
            <div class="product-badge" style="background-color: var(--primary-gold);"><?= __('NEW') ?></div>
        <?php endif; ?>
        
        <div class="product-quick-view"><?= __('QUICK VIEW') ?></div>
        
        <!-- Wishlist Button -->
        <?php
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $wishlistHelper = $objectManager->get(\Magento\Wishlist\Helper\Data::class);
        $customerSession = $objectManager->get(\Magento\Customer\Model\Session::class);
        $isLoggedIn = $customerSession->isLoggedIn();
        $isInWishlist = false;
        if ($isLoggedIn && $wishlistHelper->isAllow()) {
            $wishlist = $objectManager->get(\Magento\Wishlist\Model\Wishlist::class);
            $wishlist->loadByCustomerId($customerSession->getCustomerId(), true);
            $isInWishlist = $wishlist->getItemCollection()->getItemByColumnValue('product_id', $_product->getId()) !== null;
        }
        ?>
        <?php if ($isLoggedIn && $wishlistHelper->isAllow()): ?>
            <a href="<?= $block->escapeUrl($wishlistHelper->getAddParams($_product)) ?>" 
               class="product-wishlist-btn <?= $isInWishlist ? 'in-wishlist' : '' ?>"
               data-action="add-to-wishlist"
               title="<?= $block->escapeHtmlAttr($isInWishlist ? __('Remove from Wishlist') : __('Add to Wishlist')) ?>">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="<?= $isInWishlist ? 'currentColor' : 'none' ?>" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </a>
        <?php endif; ?>
    </div>
    
    <!-- Product Info -->
    <div class="product-info">
        <?php
        // Safely get brand attribute
        $brand = null;
        try {
            $brandAttr = $_product->getResource()->getAttribute('brand');
            if ($brandAttr && $brandAttr->getId()) {
                $brandValue = $_product->getData('brand');
                if ($brandValue) {
                    $source = $brandAttr->getSource();
                    if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                        $brand = $source->getOptionText($brandValue);
                        // Ensure brand is a valid string
                        if (empty($brand) || $brand === false || $brand === null) {
                            $brand = null;
                        }
                    }
                }
            }
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        if ($brand): ?>
            <div class="product-brand"><?= $block->escapeHtml($brand) ?></div>
        <?php endif; ?>
        
        <h3 class="product-name product-item-name">
            <a href="<?= $block->escapeUrl($_product->getProductUrl()) ?>" 
               class="product-item-link"
               title="<?= $block->escapeHtmlAttr($_product->getName()) ?>">
                <?= /* @noEscape */ $_helper ? $_helper->productAttribute($_product, $_product->getName(), 'name') : $block->escapeHtml($_product->getName()) ?>
            </a>
        </h3>
        
        <div class="product-price price">
            <?= /* @noEscape */ $parentBlock ? $parentBlock->getProductPrice($_product) : '' ?>
        </div>
        
        <div class="product-details-row">
            <?php if ($_product->isSaleable() && $parentBlock): ?>
                <?php $postParams = $parentBlock->getAddToCartPostParams($_product); ?>
                <form data-role="tocart-form"
                      data-product-sku="<?= $block->escapeHtmlAttr($_product->getSku()) ?>"
                      action="<?= $block->escapeUrl($postParams['action']) ?>"
                      data-mage-init='{"catalogAddToCart": {}}'
                      method="post">
                    <?php 
                    $viewModel = $parentBlock->getData('viewModel');
                    if ($viewModel) {
                        $options = $viewModel->getOptionsData($_product);
                        foreach ($options as $optionItem): ?>
                            <input type="hidden"
                                   name="<?= $block->escapeHtmlAttr($optionItem['name']) ?>"
                                   value="<?= $block->escapeHtmlAttr($optionItem['value']) ?>">
                        <?php endforeach;
                    }
                    ?>
                    <input type="hidden"
                           name="product"
                           value="<?= /* @noEscape */ $postParams['data']['product'] ?>">
                    <input type="hidden"
                           name="<?= /* @noEscape */ Action::PARAM_NAME_URL_ENCODED ?>"
                           value="<?= /* @noEscape */ $postParams['data'][Action::PARAM_NAME_URL_ENCODED] ?>">
                    <?= $parentBlock->getBlockHtml('formkey') ?>
                    <button type="submit"
                            title="<?= $block->escapeHtmlAttr(__('Add to Cart')) ?>"
                            class="product-add-to-cart action tocart primary">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"></path>
                            <line x1="3" y1="6" x2="21" y2="6"></line>
                            <path d="M16 10a4 4 0 0 1-8 0"></path>
                        </svg>
                        <span><?= $block->escapeHtml(__('ADD TO CART')) ?></span>
                    </button>
                </form>
            <?php else: ?>
                <?php if ($_product->isAvailable()): ?>
                    <div class="stock available">
                        <span><?= $block->escapeHtml(__('In stock')) ?></span>
                    </div>
                <?php else: ?>
                    <div class="stock unavailable">
                        <span><?= $block->escapeHtml(__('Out of stock')) ?></span>
                    </div>
                <?php endif; ?>
            <?php endif; ?>
        </div>
    </div>
</div>

