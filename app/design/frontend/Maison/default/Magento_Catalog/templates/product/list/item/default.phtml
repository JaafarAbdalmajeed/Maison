<?php
/**
 * Product List Item Template - Matching Design
 * @var \Magento\Framework\View\Element\Template $block
 */
use Magento\Framework\App\Action\Action;

// Get product from parent block (ListProduct)
$_product = $block->getData('product');
if (!$_product) {
    return;
}

// Get helper and parent block
$_helper = $block->getData('outputHelper');
$parentBlock = $block->getParentBlock();
$imageDisplayArea = 'category_page_grid';
$pos = $parentBlock ? $parentBlock->getPositioned() : null;
?>
<div class="product-card product-item" data-container="product-grid">
    <?php
    $productImage = $block->getImage($_product, $imageDisplayArea);
    ?>
    
    <!-- Product Image Wrapper -->
    <div class="product-image-wrapper">
        <a href="<?= $block->escapeUrl($_product->getProductUrl()) ?>" 
           class="product-image-link"
           title="<?= $block->escapeHtmlAttr($_product->getName()) ?>">
            <?php
            $productImage = $parentBlock ? $parentBlock->getImage($_product, $imageDisplayArea) : null;
            if ($productImage) {
                echo $productImage->toHtml();
            }
            ?>
        </a>
        
        <?php
        // Product Badge (if bestseller or new) - Safely check
        $isBestseller = false;
        $isNew = false;
        
        try {
            $bestsellerValue = $_product->getAttributeText('bestseller');
            $isBestseller = !empty($bestsellerValue) && ($bestsellerValue !== false && $bestsellerValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        
        try {
            $newValue = $_product->getAttributeText('new');
            $isNew = !empty($newValue) && ($newValue !== false && $newValue !== null);
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        
        if ($isBestseller): ?>
            <div class="product-badge"><?= __('BEST SELLER') ?></div>
        <?php elseif ($isNew): ?>
            <div class="product-badge" style="background-color: var(--primary-gold);"><?= __('NEW') ?></div>
        <?php endif; ?>
        
        <div class="product-quick-view"><?= __('QUICK VIEW') ?></div>
        
        <!-- Wishlist Button -->
        <?php
        $objectManager = \Magento\Framework\App\ObjectManager::getInstance();
        $wishlistHelper = $objectManager->get(\Magento\Wishlist\Helper\Data::class);
        $customerSession = $objectManager->get(\Magento\Customer\Model\Session::class);
        $isLoggedIn = $customerSession->isLoggedIn();
        $isInWishlist = false;
        if ($isLoggedIn && $wishlistHelper->isAllow()) {
            $wishlist = $objectManager->get(\Magento\Wishlist\Model\Wishlist::class);
            $wishlist->loadByCustomerId($customerSession->getCustomerId(), true);
            $isInWishlist = $wishlist->getItemCollection()->getItemByColumnValue('product_id', $_product->getId()) !== null;
        }
        ?>
        <?php if ($isLoggedIn && $wishlistHelper->isAllow()): ?>
            <a href="<?= $block->escapeUrl($wishlistHelper->getAddParams($_product)) ?>" 
               class="product-wishlist-btn <?= $isInWishlist ? 'in-wishlist' : '' ?>"
               data-action="add-to-wishlist"
               title="<?= $block->escapeHtmlAttr($isInWishlist ? __('Remove from Wishlist') : __('Add to Wishlist')) ?>">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="<?= $isInWishlist ? 'currentColor' : 'none' ?>" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
            </a>
        <?php endif; ?>
    </div>
    
    <!-- Product Info -->
    <div class="product-info">
        <?php
        // Safely get brand attribute
        $brand = null;
        try {
            $brandAttr = $_product->getResource()->getAttribute('brand');
            if ($brandAttr && $brandAttr->getId()) {
                $brandValue = $_product->getData('brand');
                if ($brandValue) {
                    $source = $brandAttr->getSource();
                    if ($source && is_object($source) && method_exists($source, 'getOptionText')) {
                        $brand = $source->getOptionText($brandValue);
                        // Ensure brand is a valid string
                        if (empty($brand) || $brand === false || $brand === null) {
                            $brand = null;
                        }
                    }
                }
            }
        } catch (\Exception $e) {
            // Attribute doesn't exist, ignore
        } catch (\Throwable $e) {
            // Catch any other errors
        }
        if ($brand): ?>
            <div class="product-brand"><?= $block->escapeHtml($brand) ?></div>
        <?php endif; ?>
        
        <div class="product-details-row">
            <?php if ($_product->isSaleable() && $parentBlock): ?>
                <?php $postParams = $parentBlock->getAddToCartPostParams($_product); ?>
                <button type="button"
                        class="product-add-to-cart"
                        data-product-id="<?= (int)$_product->getId() ?>"
                        data-product-name="<?= $block->escapeHtmlAttr($_product->getName()) ?>"
                        data-product-url="<?= $block->escapeUrl($postParams['action']) ?>"
                        data-product-sku="<?= $block->escapeHtmlAttr($_product->getSku()) ?>"
                        data-form-key="<?= $block->escapeHtmlAttr($parentBlock->getBlockHtml('formkey')) ?>"
                        data-post-params="<?= $block->escapeHtmlAttr(json_encode($postParams['data'])) ?>"
                        title="<?= $block->escapeHtmlAttr(__('Add to Cart')) ?>">
                    <i data-feather="shopping-bag"></i>
                    <span><?= $block->escapeHtml(__('ADD TO CART')) ?></span>
                </button>
                <div>
                    <h3 class="product-name mb-2">
                        <a href="<?= $block->escapeUrl($_product->getProductUrl()) ?>"
                           title="<?= $block->escapeHtmlAttr($_product->getName()) ?>">
                            <?= /* @noEscape */ $_helper ? $_helper->productAttribute($_product, $_product->getName(), 'name') : $block->escapeHtml($_product->getName()) ?>
                        </a>
                    </h3>
                    <div class="product-price">
                        <?= /* @noEscape */ $parentBlock ? $parentBlock->getProductPrice($_product) : '' ?>
                    </div>
                </div>
            <?php else: ?>
                <div class="product-unavailable">
                    <?php if ($_product->isAvailable()): ?>
                        <span class="stock available"><?= $block->escapeHtml(__('In stock')) ?></span>
                    <?php else: ?>
                        <span class="stock unavailable"><?= $block->escapeHtml(__('Out of stock')) ?></span>
                    <?php endif; ?>
                </div>
            <?php endif; ?>
        </div>
    </div>
</div>

