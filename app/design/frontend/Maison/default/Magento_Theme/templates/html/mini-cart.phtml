<?php
/**
 * Maison de Pierre - Mini Cart Sidebar
 */
$objectManager = \Magento\Framework\App\ObjectManager::getInstance();
$cart = $objectManager->get('\Magento\Checkout\Model\Cart');
$checkoutSession = $objectManager->get('\Magento\Checkout\Model\Session');

try {
    // Get quote from session (more reliable)
    $quote = $checkoutSession->getQuote();
    
    // Ensure quote is loaded
    if (!$quote->getId()) {
        $quote = $cart->getQuote();
    }
    
    // Load quote with all items
    if ($quote->getId()) {
        $quote->load($quote->getId());
    }
    
    // Collect totals to ensure items are loaded
    $quote->collectTotals();
    
    // Get all visible items
    $items = $quote->getAllVisibleItems();
    
    // If no visible items, try all items
    if (empty($items)) {
        $items = $quote->getAllItems();
    }
    
    $subtotal = $quote->getSubtotal() ?: $quote->getGrandTotal();
    
} catch (\Exception $e) {
    $items = [];
    $subtotal = 0;
}
?>
<!-- Mini Cart Sidebar -->
<div class="mini-cart" id="miniCart">
    <div class="mini-cart-overlay" id="miniCartOverlay"></div>
    <div class="mini-cart-panel">
        <div class="mini-cart-header">
            <h3 class="mini-cart-title"><?= __('Shopping Bag') ?></h3>
            <button class="mini-cart-close" id="miniCartClose">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
            </button>
        </div>
        <div class="mini-cart-items" id="miniCartItems">
            <?php if (!empty($items) && count($items) > 0): ?>
                <?php foreach ($items as $item): ?>
                    <?php 
                    try {
                        $product = $item->getProduct();
                        if (!$product || !$product->getId()) {
                            continue; // Skip invalid items
                        }
                        
                        $imageHelper = $objectManager->get('\Magento\Catalog\Helper\Image');
                        $imageUrl = $imageHelper->init($product, 'product_thumbnail_image')
                            ->setImageFile($product->getSmallImage())
                            ->resize(200, 200)
                            ->getUrl();
                        if (!$imageUrl || $imageUrl == '') {
                            $imageUrl = $block->getViewFileUrl('images/placeholder.jpg');
                        }
                    } catch (\Exception $e) {
                        continue; // Skip items with errors
                    }
                    ?>
                    <div class="mini-cart-item" data-item-id="<?= $item->getId() ?>">
                        <div class="mini-cart-item-image">
                            <img src="<?= $block->escapeUrl($imageUrl) ?>" alt="<?= $block->escapeHtml($item->getName()) ?>">
                        </div>
                        <div class="mini-cart-item-details">
                            <h4 class="mini-cart-item-name"><?= $block->escapeHtml($item->getName()) ?></h4>
                            <p class="mini-cart-item-brand"><?= $block->escapeHtml($product->getAttributeText('manufacturer') ?: 'Maison') ?></p>
                            <div class="mini-cart-item-qty">
                                <button class="qty-btn minus" data-item-id="<?= $item->getId() ?>">âˆ’</button>
                                <span class="qty-value"><?= (int)$item->getQty() ?></span>
                                <button class="qty-btn plus" data-item-id="<?= $item->getId() ?>">+</button>
                            </div>
                        </div>
                        <div class="mini-cart-item-price">
                            <p class="item-price">$<?= number_format($item->getPrice() ?: 0, 2) ?></p>
                            <button class="item-remove" data-item-id="<?= $item->getId() ?>">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-trash-2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </div>
                    </div>
                <?php endforeach; ?>
            <?php else: ?>
                <div class="mini-cart-empty">
                    <p><?= __('Your shopping bag is empty') ?></p>
                    <a href="<?= $block->getUrl('catalog') ?>" class="btn-cart-view"><?= __('Continue Shopping') ?></a>
                </div>
            <?php endif; ?>
        </div>
        <div class="mini-cart-footer">
            <div class="mini-cart-subtotal">
                <span><?= __('Subtotal') ?></span>
                <span class="subtotal-amount">$<?= number_format($subtotal ?: 0, 2) ?></span>
            </div>
            <p class="mini-cart-note"><?= __('Shipping and taxes calculated at checkout') ?></p>
            <a href="<?= $block->getUrl('checkout') ?>" class="btn-cart-checkout"><?= __('PROCEED TO CHECKOUT') ?></a>
            <a href="<?= $block->getUrl('checkout/cart') ?>" class="btn-cart-view"><?= __('VIEW SHOPPING BAG') ?></a>
        </div>
    </div>
</div>
